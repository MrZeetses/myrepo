<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TeleMed</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:#080d1a;color:#f1f5f9;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#080d1a}::-webkit-scrollbar-thumb{background:#263350;border-radius:4px}
input,select,button,textarea{font-family:'IBM Plex Sans',sans-serif}
button{cursor:pointer;transition:filter .15s,transform .1s}
button:hover:not(:disabled){filter:brightness(1.1)}
button:active:not(:disabled){transform:scale(.97)}
button:disabled{opacity:.5;cursor:not-allowed}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes popIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.fade-up{animation:fadeUp .4s cubic-bezier(.22,1,.36,1) both}
.fade-in{animation:fadeIn .3s ease both}
.pop-in{animation:popIn .3s cubic-bezier(.34,1.56,.64,1) both}

/* Pages */
.page{display:none;min-height:100vh}
.page.active{display:flex;flex-direction:column}

/* Colors */
:root{
  --bg:#080d1a;--surface:#0f172a;--card:#141e33;
  --border:#1e293b;--border2:#263350;
  --text:#f1f5f9;--muted:#64748b;--dim:#475569;
  --accent:#6366f1;--accent2:#8b5cf6;
  --green:#10b981;--yellow:#f59e0b;--red:#ef4444;--blue:#3b82f6;
  --grad:linear-gradient(135deg,#6366f1,#8b5cf6);
}

/* Inputs */
input,select{width:100%;padding:11px 14px;border-radius:10px;background:var(--card);border:1px solid var(--border2);color:var(--text);font-size:14px;outline:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--accent)}
input[type=date],input[type=time]{color-scheme:dark}

/* Buttons */
.btn{padding:11px 22px;border-radius:10px;font-size:14px;font-weight:600;line-height:1;display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none}
.btn-primary{background:var(--grad);color:#fff}
.btn-secondary{background:transparent;color:var(--muted);border:1px solid var(--border2)}
.btn-danger{background:transparent;color:var(--red);border:1px solid #ef444466}
.btn-red{background:var(--red);color:#fff}
.btn-green{background:linear-gradient(135deg,#059669,var(--green));color:#fff}
.btn-ghost{background:transparent;color:var(--muted)}
.btn-full{width:100%}
.btn-link{background:none;border:none;color:var(--accent);font-size:13px;text-decoration:underline;text-underline-offset:3px}

/* Alerts */
.alert{padding:12px 16px;border-radius:10px;font-size:13px;line-height:1.6}
.alert-error{background:#ef444418;border:1px solid #ef444444;color:#fca5a5}
.alert-success{background:#10b98118;border:1px solid #10b98144;color:var(--green)}
.alert-info{background:#3b82f618;border:1px solid #3b82f644;color:var(--blue)}
.alert-yellow{background:#f59e0b11;border:1px solid #f59e0b44;color:var(--yellow)}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;letter-spacing:.04em;white-space:nowrap}
.badge-blue{background:#3b82f622;color:var(--blue);border:1px solid #3b82f644}
.badge-yellow{background:#f59e0b22;color:var(--yellow);border:1px solid #f59e0b44}
.badge-red{background:#ef444422;color:var(--red);border:1px solid #ef444444}
.badge-green{background:#10b98122;color:var(--green);border:1px solid #10b98144}
.badge-purple{background:#8b5cf622;color:var(--accent2);border:1px solid #8b5cf644}

/* Form */
.form-col{display:flex;flex-direction:column;gap:14px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-label{color:var(--muted);font-size:12px;font-weight:500;margin-bottom:6px;display:block}
.form-group{display:flex;flex-direction:column}
hr.sep{border:none;border-top:1px solid var(--border);margin:2px 0}

/* Spinner */
.spinner{width:42px;height:42px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}

/* Toast */
#toast{position:fixed;bottom:28px;right:28px;z-index:9999;background:var(--card);border-radius:12px;padding:14px 20px;max-width:360px;box-shadow:0 16px 48px #000a;display:none;align-items:center;gap:12px;font-size:14px}
#toast.show{display:flex;animation:popIn .3s ease}
.toast-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:#00000099;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(6px);padding:24px}
.modal-overlay.show{display:flex;animation:fadeIn .25s ease}
.modal-box{background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:32px;width:100%;max-width:480px;box-shadow:0 32px 96px #000b;animation:popIn .3s cubic-bezier(.34,1.56,.64,1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.modal-title{font-family:'Playfair Display',Georgia,serif;font-size:17px;color:var(--text)}
.modal-close{background:none;border:none;color:var(--muted);font-size:22px}
.modal-btns{display:flex;gap:10px;margin-top:24px}

/* Logo */
.logo-wrap{display:flex;align-items:center;gap:12px}
.logo-icon{width:52px;height:52px;border-radius:15px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
.logo-icon-sm{width:36px;height:36px;border-radius:10px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.logo-name{font-family:'Playfair Display',Georgia,serif;font-size:28px;font-weight:700;color:var(--text);line-height:1.1}
.logo-name-sm{font-size:17px}
.logo-sub{color:var(--muted);font-size:11px;margin-top:2px}

/* ‚îÄ‚îÄ AUTH PAGE ‚îÄ‚îÄ */
#page-auth{flex-direction:row;background:radial-gradient(ellipse at 70% 20%,#1e1b4b88,#080d1a 65%)}
.auth-left{flex:1;display:flex;flex-direction:column;justify-content:center;padding:60px 80px;border-right:1px solid var(--border)}
.auth-right{width:460px;display:flex;align-items:center;justify-content:center;padding:40px}
.auth-card{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:36px;box-shadow:0 24px 80px #0008}
.auth-tabs{display:flex;border:1px solid var(--border2);border-radius:10px;overflow:hidden;margin-bottom:24px}
.auth-tab{flex:1;padding:11px;background:transparent;color:var(--muted);border:none;font-size:13px;font-weight:600;transition:all .2s}
.auth-tab.active{background:var(--grad);color:#fff}
.role-selector{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:4px}
.role-card{border:1px solid var(--border2);border-radius:10px;padding:14px;cursor:pointer;transition:all .2s;text-align:center;background:transparent}
.role-card:hover{border-color:var(--accent);background:#6366f111}
.role-card.selected{border-color:var(--accent);background:#6366f118}
.role-card-icon{font-size:24px;margin-bottom:6px}
.role-card-label{color:var(--text);font-size:13px;font-weight:600}
.role-card-sub{color:var(--muted);font-size:11px;margin-top:2px}
.login-title{font-family:'Playfair Display',Georgia,serif;font-size:36px;color:var(--text);line-height:1.2;margin:52px 0 16px}
.login-title span{color:var(--accent)}
.login-desc{color:var(--muted);font-size:14px;line-height:1.8;max-width:400px}
.feature-list{margin-top:48px;display:flex;flex-direction:column;gap:16px}
.feature-item{display:flex;align-items:center;gap:14px}
.feature-icon{width:36px;height:36px;border-radius:10px;background:#6366f118;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.feature-text{color:var(--dim);font-size:14px}

/* ‚îÄ‚îÄ ADMIN LAYOUT ‚îÄ‚îÄ */
#page-admin{flex-direction:row;height:100vh;overflow:hidden}
.sidebar{width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-brand{padding:24px 20px 20px;border-bottom:1px solid var(--border)}
.sidebar-user{padding:16px 20px;border-bottom:1px solid var(--border)}
.user-name{color:var(--text);font-size:13px;font-weight:500;margin-bottom:2px}
.user-role-label{color:var(--muted);font-size:11px;margin-bottom:10px}
.sidebar-stats{padding:16px;border-bottom:1px solid var(--border)}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:12px 14px}
.stat-num{font-size:22px;font-weight:700;line-height:1}
.stat-label{color:var(--muted);font-size:10px;margin-top:4px}
.sidebar-nav{padding:12px;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;font-size:13px;cursor:pointer;margin-bottom:2px;transition:all .2s}
.nav-item.active{background:#6366f120;color:#a5b4fc;font-weight:500}
.nav-item:not(.active){color:var(--muted)}
.admin-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:16px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;background:var(--surface);flex-shrink:0}
.topbar-title{flex:1;font-family:'Playfair Display',Georgia,serif;font-size:20px;color:var(--text)}
.filters{padding:12px 28px;border-bottom:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--surface);flex-shrink:0}
.filter-search{flex:1;min-width:200px}
.content-area{flex:1;display:flex;overflow:hidden}
.list-panel{flex:1;overflow-y:auto}

/* Consultation row */
.c-row{padding:14px 24px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
.c-row:hover{background:var(--card)}
.c-row.selected{background:var(--card)}
.c-row-top{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
.c-row-name{color:var(--text);font-size:14px;font-weight:500}
.c-row-sub{color:var(--dim);font-size:12px;margin-bottom:2px}
.c-row-date{color:var(--muted);font-size:11px}
.section-toggle{padding:10px 24px;background:var(--card);border-top:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;color:var(--dim);font-size:13px}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:320px;gap:12px;color:var(--muted)}
.empty-icon{font-size:52px}

/* Detail sidebar */
.detail-sidebar{width:360px;background:var(--surface);border-left:1px solid var(--border);display:none;flex-direction:column;flex-shrink:0;height:100%}
.detail-sidebar.show{display:flex;animation:fadeIn .25s ease}
.detail-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.detail-title{color:var(--text);font-size:15px;font-weight:600}
.detail-body{flex:1;padding:24px;overflow-y:auto;display:flex;flex-direction:column;gap:18px}
.d-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;padding:6px 0}
.d-label{color:var(--muted);font-size:13px;flex-shrink:0}
.d-value{color:var(--text);font-size:13px;text-align:right}
.d-sep{border:none;border-top:1px solid var(--border)}
.link-box{background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:12px;display:flex;gap:10px;align-items:flex-start}
.link-url{font-family:'IBM Plex Mono',monospace;color:#a5b4fc;font-size:11px;word-break:break-all;flex:1}
.btn-copy{background:var(--border2);border:none;border-radius:6px;padding:4px 10px;color:var(--text);font-size:11px;flex-shrink:0}
.detail-actions{padding:16px 24px 24px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:10px}

/* ‚îÄ‚îÄ DOCTOR CABINET ‚îÄ‚îÄ */
#page-doctor{flex-direction:row;height:100vh;overflow:hidden}
.doctor-consult-list{flex:1;overflow-y:auto}
.upcoming-card{margin:16px 24px;background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:20px}
.upcoming-label{color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px}
.upcoming-name{color:var(--text);font-size:18px;font-weight:600;margin-bottom:4px}
.upcoming-date{color:var(--dim);font-size:13px;margin-bottom:16px}

/* ‚îÄ‚îÄ PATIENT CABINET ‚îÄ‚îÄ */
#page-patient{flex-direction:row;height:100vh;overflow:hidden}

/* ‚îÄ‚îÄ WAITING PAGE ‚îÄ‚îÄ */
#page-waiting{align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 10%,#1e1b4b55,#080d1a 70%);padding:24px;gap:36px}
.waiting-card{background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:44px;max-width:520px;width:100%;text-align:center}
.countdown{display:flex;align-items:center;justify-content:center;gap:16px;margin:20px 0 36px}
.cd-unit{text-align:center}
.cd-num{font-family:'IBM Plex Mono',monospace;font-size:56px;font-weight:700;color:var(--text);line-height:1}
.cd-label{color:var(--muted);font-size:12px;margin-top:6px}
.cd-sep{font-family:monospace;font-size:44px;color:var(--accent);line-height:1;opacity:.6}

/* ‚îÄ‚îÄ CALL PAGE ‚îÄ‚îÄ */
#page-call{position:relative;overflow:hidden;background:#000;min-height:100vh}
#page-call.active{display:block}
#remote-video{width:100%;height:100vh;object-fit:cover;display:block}
#local-video-wrap{position:absolute;top:16px;right:16px;width:180px;border-radius:12px;overflow:hidden;border:2px solid var(--border2);box-shadow:0 8px 32px #000b;transition:right .3s ease}
#local-video{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
.call-peer-label{position:absolute;top:16px;left:16px;background:#00000088;backdrop-filter:blur(8px);border-radius:10px;padding:8px 14px;color:#ffffffcc;font-size:13px}
.call-controls{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);display:flex;gap:14px;align-items:center}
.ctrl-btn{width:52px;height:52px;border-radius:50%;background:#ffffff22;border:1px solid #ffffff33;backdrop-filter:blur(8px);color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;position:relative}
.ctrl-btn.off{background:#ef4444cc;border-color:var(--red)}
.ctrl-btn.on{background:#6366f1cc;border-color:var(--accent)}
.ctrl-badge{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center}
.btn-end{width:64px;height:64px;border-radius:50%;background:var(--red);border:none;color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px #ef444488}
.waiting-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000c}
#chat-panel{position:absolute;right:0;top:0;bottom:0;width:360px;background:#0f172aee;backdrop-filter:blur(16px);border-left:1px solid var(--border2);display:none;flex-direction:column}
#chat-panel.show{display:flex;animation:fadeIn .25s ease}
.chat-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.chat-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
.msg-wrap{display:flex}
.msg-wrap.mine{justify-content:flex-end}
.bubble{max-width:76%;padding:9px 13px;border-radius:12px;font-size:14px;line-height:1.5;color:var(--text)}
.bubble.mine{background:var(--accent);border:1px solid var(--accent2);border-bottom-right-radius:3px}
.bubble.theirs{background:var(--card);border:1px solid var(--border2);border-bottom-left-radius:3px}
.bubble-from{color:#a5b4fc;font-size:11px;font-weight:600;margin-bottom:4px}
.bubble-time{font-size:10px;margin-top:4px;text-align:right}
.bubble-time.mine{color:#ffffffaa}.bubble-time.theirs{color:var(--muted)}
.chat-input-row{padding:16px;border-top:1px solid var(--border);display:flex;gap:10px}

/* ‚îÄ‚îÄ INFO / ENDED ‚îÄ‚îÄ */
#page-ended,#page-info{align-items:center;justify-content:center;padding:24px}
.info-card{background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:52px;max-width:440px;width:100%;text-align:center}
.info-icon{font-size:56px;margin-bottom:20px}
.info-title{font-family:'Playfair Display',Georgia,serif;font-size:22px;color:var(--text);margin-bottom:12px}
.info-text{color:var(--muted);font-size:14px;line-height:1.7}

@media(max-width:900px){
  .auth-left{display:none}
  #page-auth{justify-content:center}
  .auth-right{width:100%;max-width:460px}
  .sidebar{width:220px}
  .detail-sidebar{width:300px}
}
@media(max-width:640px){
  .sidebar{display:none}
  .auth-right{padding:20px}
  .auth-right{width:100%}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="page-loading" class="page active" style="align-items:center;justify-content:center">
  <div class="spinner"></div>
</div>

<!-- AUTH -->
<div id="page-auth" class="page">
  <div class="auth-left fade-up">
    <div class="logo-wrap">
      <div class="logo-icon">üè•</div>
      <div><div class="logo-name">TeleMed</div><div class="logo-sub">–ú–æ–¥—É–ª—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã</div></div>
    </div>
    <h1 class="login-title">–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏<br><span>–¥–ª—è –≤–∞—à–µ–π –∫–ª–∏–Ω–∏–∫–∏</span></h1>
    <p class="login-desc">–í–∏–¥–µ–æ–ø—Ä–∏—ë–º—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è–º–∏ ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
    <div class="feature-list">
      <div class="feature-item"><div class="feature-icon">üìÖ</div><span class="feature-text">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏—ë–º–æ–≤</span></div>
      <div class="feature-item"><div class="feature-icon">üé•</div><span class="feature-text">–ó–∞—â–∏—â—ë–Ω–Ω—ã–π WebRTC –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</span></div>
      <div class="feature-item"><div class="feature-icon">üì±</div><span class="feature-text">SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</span></div>
      <div class="feature-item"><div class="feature-icon">üí≥</div><span class="feature-text">–û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —ç–∫–≤–∞–π—Ä–∏–Ω–≥</span></div>
    </div>
  </div>
  <div class="auth-right">
    <div class="auth-card fade-up">
      <!-- Tabs -->
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login" onclick="setTab('login')">–í—Ö–æ–¥</button>
        <button class="auth-tab" id="tab-reg" onclick="setTab('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div class="form-col" id="auth-form">
        <input type="email" id="a-email" placeholder="Email" />
        <input type="password" id="a-pw" placeholder="–ü–∞—Ä–æ–ª—å" />
        <div id="auth-alert" style="display:none"></div>
        <button class="btn btn-primary btn-full" id="auth-btn" style="padding:13px 0" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <button class="btn-link" id="reset-link" onclick="toggleReset()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
      </div>

      <!-- Registration extra fields (hidden by default) -->
      <div id="reg-extra" style="display:none" class="form-col">
        <input type="text" id="a-name" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û)" />
        <input type="password" id="a-pw2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
        <!-- Role selector -->
        <div>
          <div class="form-label" style="margin-bottom:10px">–ö—Ç–æ –≤—ã?</div>
          <div class="role-selector">
            <div class="role-card selected" id="role-patient" onclick="selectRole('patient')">
              <div class="role-card-icon">üßë‚Äçüíº</div>
              <div class="role-card-label">–ü–∞—Ü–∏–µ–Ω—Ç</div>
              <div class="role-card-sub">–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º</div>
            </div>
            <div class="role-card" id="role-doctor" onclick="selectRole('doctor')">
              <div class="role-card-icon">üë®‚Äç‚öïÔ∏è</div>
              <div class="role-card-label">–í—Ä–∞—á</div>
              <div class="role-card-sub">–í–µ–¥–µ–Ω–∏–µ –ø—Ä–∏—ë–º–æ–≤</div>
            </div>
          </div>
        </div>
        <div id="specialty-wrap" style="display:none">
          <input type="text" id="a-specialty" placeholder="–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Ä–∞–ø–µ–≤—Ç)" />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN CABINET -->
<div id="page-admin" class="page">
  <div class="sidebar">
    <div class="sidebar-brand">
      <div class="logo-wrap">
        <div class="logo-icon-sm">üè•</div>
        <div><div class="logo-name logo-name-sm">TeleMed</div><div class="logo-sub">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div></div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-name" id="admin-name">‚Äî</div>
      <div class="user-role-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã</div>
      <button class="btn btn-secondary" style="padding:6px 14px;font-size:12px" onclick="doLogout()">–í—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-stats">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-num" id="s-active" style="color:var(--accent)">0</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
        <div class="stat-card"><div class="stat-num" id="s-done"   style="color:var(--green)">0</div><div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div></div>
        <div class="stat-card"><div class="stat-num" id="s-req"    style="color:var(--yellow)">0</div><div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤</div></div>
        <div class="stat-card"><div class="stat-num" id="s-cancel" style="color:var(--red)">0</div><div class="stat-label">–û—Ç–º–µ–Ω–µ–Ω–æ</div></div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active">üìã –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
    </div>
  </div>
  <div class="admin-main">
    <div class="topbar">
      <h1 class="topbar-title">–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</h1>
      <button class="btn btn-primary" onclick="openCreate()">+ –°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div class="filters">
      <input class="filter-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Ä–∞—á—É –∏–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç—É..." oninput="renderList()" id="f-search" />
      <input type="date" id="f-date" style="width:170px" onchange="renderList()" />
      <select id="f-status" onchange="renderList()" style="padding:11px 14px;border-radius:10px;background:var(--card);border:1px solid var(--border2);color:var(--text);font-size:14px;outline:none;width:auto">
        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="scheduled">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
        <option value="cancel_requested">–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É</option>
        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
      </select>
      <button class="btn btn-ghost" id="f-reset" onclick="resetFilters()" style="display:none;font-size:13px;padding:10px 14px">‚úï –°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div class="content-area">
      <div class="list-panel" id="consult-list"><div class="empty-state"><div class="spinner"></div></div></div>
      <div class="detail-sidebar" id="detail-sidebar">
        <div class="detail-header"><span class="detail-title">–î–µ—Ç–∞–ª–∏</span><button class="modal-close" onclick="closeDetail()">√ó</button></div>
        <div class="detail-body" id="detail-body"></div>
        <div class="detail-actions" id="detail-actions"></div>
      </div>
    </div>
  </div>
</div>

<!-- DOCTOR CABINET -->
<div id="page-doctor" class="page">
  <div class="sidebar">
    <div class="sidebar-brand">
      <div class="logo-wrap">
        <div class="logo-icon-sm">üè•</div>
        <div><div class="logo-name logo-name-sm">TeleMed</div><div class="logo-sub">–ö–∞–±–∏–Ω–µ—Ç –≤—Ä–∞—á–∞</div></div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-name" id="doctor-name">‚Äî</div>
      <div class="user-role-label" id="doctor-specialty">–í—Ä–∞—á</div>
      <button class="btn btn-secondary" style="padding:6px 14px;font-size:12px;margin-top:10px" onclick="doLogout()">–í—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active">üìã –ú–æ–∏ –ø—Ä–∏—ë–º—ã</div>
    </div>
  </div>
  <div class="admin-main">
    <div class="topbar"><h1 class="topbar-title">–ú–æ–∏ –ø—Ä–∏—ë–º—ã</h1></div>
    <div class="list-panel" id="doctor-list"><div class="empty-state"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- PATIENT CABINET -->
<div id="page-patient-cab" class="page">
  <div class="sidebar">
    <div class="sidebar-brand">
      <div class="logo-wrap">
        <div class="logo-icon-sm">üè•</div>
        <div><div class="logo-name logo-name-sm">TeleMed</div><div class="logo-sub">–ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞</div></div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-name" id="patient-name">‚Äî</div>
      <div class="user-role-label">–ü–∞—Ü–∏–µ–Ω—Ç</div>
      <button class="btn btn-secondary" style="padding:6px 14px;font-size:12px;margin-top:10px" onclick="doLogout()">–í—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active">üìã –ú–æ–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
    </div>
  </div>
  <div class="admin-main">
    <div class="topbar"><h1 class="topbar-title">–ú–æ–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</h1></div>
    <div class="list-panel" id="patient-list"><div class="empty-state"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- WAITING ROOM -->
<div id="page-waiting" class="page">
  <div class="logo-wrap fade-up">
    <div class="logo-icon">üè•</div>
    <div><div class="logo-name">TeleMed</div><div class="logo-sub">–ú–æ–¥—É–ª—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã</div></div>
  </div>
  <div class="waiting-card fade-up">
    <div style="color:var(--muted);font-size:13px;font-weight:500;margin-bottom:8px" id="w-role-label">–í–∞—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</div>
    <h2 style="font-family:'Playfair Display',serif;font-size:24px;color:var(--text);margin-bottom:6px" id="w-name">‚Äî</h2>
    <div style="color:var(--dim);font-size:15px;margin-bottom:8px" id="w-date">‚Äî</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:20px">–î–æ –Ω–∞—á–∞–ª–∞:</div>
    <div class="countdown">
      <div class="cd-unit"><div class="cd-num" id="cd-h">00</div><div class="cd-label">—á–∞—Å–æ–≤</div></div>
      <div class="cd-sep">:</div>
      <div class="cd-unit"><div class="cd-num" id="cd-m">00</div><div class="cd-label">–º–∏–Ω—É—Ç</div></div>
      <div class="cd-sep">:</div>
      <div class="cd-unit"><div class="cd-num" id="cd-s">00</div><div class="cd-label">—Å–µ–∫—É–Ω–¥</div></div>
    </div>
    <div class="alert alert-info" style="text-align:left;font-size:13px">
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.
    </div>
  </div>
</div>

<!-- CALL -->
<div id="page-call" class="page" style="display:none;position:relative;min-height:100vh;background:#000">
  <video id="remote-video" autoplay playsinline style="width:100%;height:100vh;object-fit:cover;display:block"></video>
  <div id="waiting-overlay" class="waiting-overlay">
    <div class="spinner" style="width:44px;height:44px"></div>
    <p style="color:var(--muted);margin-top:20px;font-size:15px" id="w-peer-text">–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
  </div>
  <div id="local-video-wrap"><video id="local-video" autoplay playsinline muted></video></div>
  <div class="call-peer-label" id="call-peer-label">‚Äî</div>
  <div class="call-controls">
    <button class="ctrl-btn" id="btn-mic" onclick="toggleMic()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üéô</button>
    <button class="ctrl-btn" id="btn-cam" onclick="toggleCam()" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
    <div style="position:relative">
      <button class="ctrl-btn" id="btn-chat" onclick="toggleChat()" title="–ß–∞—Ç">üí¨</button>
      <div class="ctrl-badge" id="chat-badge" style="display:none">0</div>
    </div>
    <button class="btn-end" onclick="endCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">üìµ</button>
  </div>
  <div id="chat-panel">
    <div class="chat-header">
      <span style="color:var(--text);font-weight:600">–ß–∞—Ç</span>
      <button class="modal-close" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-msgs" id="chat-msgs"><div style="color:var(--muted);font-size:13px;text-align:center;margin-top:48px">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É...</div></div>
    <div class="chat-input-row">
      <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMsg()" style="flex:1"/>
      <button class="btn btn-primary" style="padding:11px 16px" onclick="sendMsg()">‚Üí</button>
    </div>
  </div>
</div>

<!-- ENDED -->
<div id="page-ended" class="page">
  <div class="info-card fade-up">
    <div class="info-icon">‚úÖ</div>
    <h2 class="info-title">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
    <p class="info-text" id="ended-text">–°–ø–∞—Å–∏–±–æ! –ü—Ä–∏—ë–º —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.</p>
    <div id="ended-email-sec" style="display:none;margin-top:24px;display:flex;flex-direction:column;gap:12px;max-width:320px;margin:24px auto 0">
      <input type="email" id="ended-email" placeholder="Email –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"/>
      <button class="btn btn-primary btn-full" onclick="sendHistory()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>
    <p id="ended-sent" style="display:none;color:var(--green);font-size:13px;margin-top:12px"></p>
  </div>
</div>

<!-- INFO -->
<div id="page-info" class="page">
  <div class="info-card fade-up">
    <div class="info-icon" id="info-icon">‚ÑπÔ∏è</div>
    <h2 class="info-title" id="info-title">‚Äî</h2>
    <p class="info-text" id="info-text">‚Äî</p>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-create">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">–ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</span>
      <button class="modal-close" onclick="closeCreate()">√ó</button>
    </div>
    <div id="create-body"></div>
  </div>
</div>

<div class="modal-overlay" id="modal-confirm">
  <div class="modal-box" style="max-width:400px">
    <div class="modal-header">
      <span class="modal-title" id="conf-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
      <button class="modal-close" onclick="closeConfirm()">√ó</button>
    </div>
    <p id="conf-text" style="color:var(--muted);font-size:14px;line-height:1.6"></p>
    <div class="modal-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeConfirm()">–ù–µ—Ç</button>
      <button class="btn btn-red" style="flex:1" id="conf-ok">–î–∞</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast">
  <div class="toast-icon" id="toast-icon"></div>
  <span id="toast-msg"></span>
  <button onclick="hideToast()" style="background:none;border:none;color:var(--muted);font-size:18px;margin-left:8px">√ó</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL      = 'https://klskklkgltlkbnimhuna.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_6Rar90QvqMtOrqboEJWFpQ_YYr3r_KL';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser    = null;
let currentProfile = null;
let consultations  = [];
let selectedId     = null;
let showDone       = false;
let rtChannel      = null;
let cdTimer        = null;
let callRole       = null;
let callId         = null;
let localStream    = null;
let peerConn       = null;
let sigCh          = null;
let chatMsgs       = [];
let chatOpen       = false;
let unread         = 0;
let micOn          = true;
let camOn          = true;
let authMode       = 'login';
let resetMode      = false;
let regRole        = 'patient';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pad = n => String(n).padStart(2,'0');
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const fmtDate = d => new Date(d).toLocaleString('ru-RU',{day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});
const isExpired  = c => !c ? false : (c.status==='cancelled'||c.status==='completed') ? true : Date.now() > new Date(c.scheduled_at).getTime()+3*60*60*1000;
const isActive   = c => { if(!c) return false; const s=new Date(c.scheduled_at).getTime(); return Date.now()>=s && Date.now()<s+3*60*60*1000; };

function statusBadge(s){
  const m={scheduled:['–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ','badge-blue'],cancel_requested:['–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É','badge-yellow'],cancelled:['–û—Ç–º–µ–Ω–µ–Ω–æ','badge-red'],completed:['–ó–∞–≤–µ—Ä—à–µ–Ω–æ','badge-green']};
  const [l,c]=m[s]||m.scheduled; return `<span class="badge ${c}">${l}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='';});
  const el=document.getElementById('page-'+id);
  if(el){el.classList.add('active');if(id==='call')el.style.display='block';}
}
function showInfo(icon,title,text){
  document.getElementById('info-icon').textContent=icon;
  document.getElementById('info-title').textContent=title;
  document.getElementById('info-text').textContent=text;
  showPage('info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTmr=null;
function showToast(msg,type='info'){
  const cols={success:'#10b981',error:'#ef4444',info:'#3b82f6'};
  const icos={success:'‚úì',error:'‚úï',info:'‚Ñπ'};
  const t=document.getElementById('toast');
  document.getElementById('toast-msg').textContent=msg;
  const ic=document.getElementById('toast-icon');
  ic.textContent=icos[type]||'‚Ñπ';
  ic.style.background=(cols[type]||cols.info)+'22';
  ic.style.color=cols[type]||cols.info;
  t.style.border=`1px solid ${(cols[type]||cols.info)}44`;
  t.classList.add('show');
  clearTimeout(toastTmr);
  toastTmr=setTimeout(hideToast,4000);
}
function hideToast(){document.getElementById('toast').classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('modal-create').addEventListener('click',e=>{if(e.target===e.currentTarget)closeCreate();});
document.getElementById('modal-confirm').addEventListener('click',e=>{if(e.target===e.currentTarget)closeConfirm();});
function closeConfirm(){document.getElementById('modal-confirm').classList.remove('show');}
function showConfirm(title,text,cb){
  document.getElementById('conf-title').textContent=title;
  document.getElementById('conf-text').textContent=text;
  document.getElementById('conf-ok').onclick=()=>{closeConfirm();cb();};
  document.getElementById('modal-confirm').classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTab(tab){
  authMode=tab; resetMode=false;
  document.getElementById('tab-login').className='auth-tab'+(tab==='login'?' active':'');
  document.getElementById('tab-reg').className='auth-tab'+(tab==='reg'?' active':'');
  const regExtra=document.getElementById('reg-extra');
  const resetLink=document.getElementById('reset-link');
  const btn=document.getElementById('auth-btn');
  const pw=document.getElementById('a-pw');
  setAuthAlert('');

  if(tab==='login'){
    regExtra.style.display='none';
    pw.placeholder='–ü–∞—Ä–æ–ª—å';
    btn.textContent='–í–æ–π—Ç–∏';
    btn.onclick=doLogin;
    resetLink.style.display='block';
  } else {
    regExtra.style.display='flex';
    pw.placeholder='–ü–∞—Ä–æ–ª—å';
    btn.textContent='–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
    btn.onclick=doRegister;
    resetLink.style.display='none';
  }
}

function selectRole(role){
  regRole=role;
  document.getElementById('role-patient').className='role-card'+(role==='patient'?' selected':'');
  document.getElementById('role-doctor').className='role-card'+(role==='doctor'?' selected':'');
  document.getElementById('specialty-wrap').style.display=role==='doctor'?'':'none';
}

function toggleReset(){
  resetMode=!resetMode;
  const btn=document.getElementById('auth-btn');
  const pw=document.getElementById('a-pw');
  const link=document.getElementById('reset-link');
  const regExtra=document.getElementById('reg-extra');
  setAuthAlert('');
  if(resetMode){
    pw.style.display='none'; regExtra.style.display='none';
    btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ'; btn.onclick=doReset;
    link.textContent='‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É';
  } else {
    pw.style.display=''; 
    btn.textContent='–í–æ–π—Ç–∏'; btn.onclick=doLogin;
    link.textContent='–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?';
  }
}

function setAuthAlert(msg,ok=false){
  const el=document.getElementById('auth-alert');
  el.style.display=msg?'':'none';
  el.className='alert '+(ok?'alert-success':'alert-error');
  el.textContent=msg;
}

async function doLogin(){
  setAuthAlert('');
  const email=document.getElementById('a-email').value.trim();
  const pw=document.getElementById('a-pw').value;
  if(!email||!pw){setAuthAlert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return;}
  const btn=document.getElementById('auth-btn');
  btn.disabled=true; btn.textContent='–í—Ö–æ–¥–∏–º...';
  const {error}=await sb.auth.signInWithPassword({email,password:pw});
  btn.disabled=false; btn.textContent='–í–æ–π—Ç–∏';
  if(error) setAuthAlert(error.message);
}

async function doRegister(){
  setAuthAlert('');
  const email=document.getElementById('a-email').value.trim();
  const pw=document.getElementById('a-pw').value;
  const pw2=document.getElementById('a-pw2').value;
  const name=document.getElementById('a-name').value.trim();
  if(!email||!pw||!name){setAuthAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');return;}
  if(pw.length<6){setAuthAlert('–ü–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');return;}
  if(pw!==pw2){setAuthAlert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');return;}
  const specialty=regRole==='doctor'?document.getElementById('a-specialty').value.trim():null;
  const btn=document.getElementById('auth-btn');
  btn.disabled=true; btn.textContent='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
  const {data,error}=await sb.auth.signUp({
    email,password:pw,
    options:{data:{full_name:name,role:regRole,specialty}}
  });
  btn.disabled=false; btn.textContent='–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  if(error){setAuthAlert(error.message);return;}
  // If email confirmation disabled ‚Äî user logged in right away
  if(data.session){
    await loadProfile();
    routeByRole();
  } else {
    setAuthAlert('‚úì –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∑–∞—Ç–µ–º –≤–æ–π–¥–∏—Ç–µ.',true);
  }
}

async function doReset(){
  setAuthAlert('');
  const email=document.getElementById('a-email').value.trim();
  if(!email){setAuthAlert('–í–≤–µ–¥–∏—Ç–µ email');return;}
  const {error}=await sb.auth.resetPasswordForEmail(email,{redirectTo:window.location.href});
  if(error) setAuthAlert(error.message);
  else setAuthAlert('‚úì –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.',true);
}

async function doLogout(){
  await sb.auth.signOut();
  currentUser=null; currentProfile=null;
  showPage('auth');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE & ROUTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProfile(){
  const {data:{user}}=await sb.auth.getUser();
  currentUser=user;
  if(!user) return;
  const {data}=await sb.from('profiles').select('*').eq('id',user.id).single();
  currentProfile=data;
}

function routeByRole(){
  if(!currentProfile) return showPage('auth');
  const role=currentProfile.role;
  if(role==='admin')   enterAdmin();
  else if(role==='doctor')  enterDoctor();
  else                      enterPatientCab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterAdmin(){
  document.getElementById('admin-name').textContent=currentProfile?.full_name||currentUser?.email||'‚Äî';
  showPage('admin');
  await loadConsultations();
  subscribeRT();
}

async function loadConsultations(){
  const {data,error}=await sb.from('consultations').select('*').order('scheduled_at',{ascending:false});
  if(!error){consultations=data||[];renderStats();renderList();}
}

function subscribeRT(){
  if(rtChannel) sb.removeChannel(rtChannel);
  rtChannel=sb.channel('admin_rt')
    .on('postgres_changes',{event:'*',schema:'public',table:'consultations'},()=>loadConsultations())
    .subscribe();
}

function renderStats(){
  document.getElementById('s-active').textContent=consultations.filter(c=>!isExpired(c)&&c.status==='scheduled').length;
  document.getElementById('s-done').textContent=consultations.filter(c=>isExpired(c)||c.status==='completed').length;
  document.getElementById('s-req').textContent=consultations.filter(c=>c.status==='cancel_requested').length;
  document.getElementById('s-cancel').textContent=consultations.filter(c=>c.status==='cancelled').length;
}

function applyFilters(list){
  const q=document.getElementById('f-search').value.toLowerCase();
  const dt=document.getElementById('f-date').value;
  const st=document.getElementById('f-status').value;
  document.getElementById('f-reset').style.display=(q||dt||st!=='all')?'':'none';
  return list.filter(c=>
    (!q||c.doctor_name.toLowerCase().includes(q)||c.patient_name.toLowerCase().includes(q))&&
    (!dt||c.scheduled_at.slice(0,10)===dt)&&
    (st==='all'||c.status===st)
  );
}
function resetFilters(){document.getElementById('f-search').value='';document.getElementById('f-date').value='';document.getElementById('f-status').value='all';renderList();}

function renderList(){
  const active=applyFilters(consultations.filter(c=>!isExpired(c)));
  const done=applyFilters(consultations.filter(c=>isExpired(c)));
  const el=document.getElementById('consult-list');
  if(!active.length&&!done.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üìã</div><div style="font-size:16px">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div><div style="font-size:13px;color:var(--dim)">–ù–∞–∂–º–∏—Ç–µ ¬´+ –°–æ–∑–¥–∞—Ç—å¬ª</div></div>`;return;
  }
  let html=active.map(c=>rowHTML(c)).join('');
  if(done.length){
    html+=`<div class="section-toggle" onclick="showDone=!showDone;renderList()"><span>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ (${done.length})</span><span>${showDone?'‚ñ≤':'‚ñº'}</span></div>`;
    if(showDone) html+=done.map(c=>rowHTML(c)).join('');
  }
  el.innerHTML=html;
}

function rowHTML(c){
  const sel=selectedId===c.id?' selected':'';
  return `<div class="c-row${sel}" onclick="selectC('${c.id}')">
    <div>
      <div class="c-row-top"><span class="c-row-name">${esc(c.patient_name)}</span>${statusBadge(c.status)}</div>
      <div class="c-row-sub">–í—Ä–∞—á: ${esc(c.doctor_name)}</div>
      <div class="c-row-date">${fmtDate(c.scheduled_at)}</div>
    </div><span style="color:var(--muted)">‚Ä∫</span>
  </div>`;
}

function selectC(id){
  selectedId=selectedId===id?null:id;
  renderList();
  if(!selectedId){closeDetail();return;}
  const c=consultations.find(x=>x.id===id);
  if(c) renderDetail(c);
}
function closeDetail(){selectedId=null;document.getElementById('detail-sidebar').classList.remove('show');renderList();}

function renderDetail(c){
  const expired=isExpired(c);
  const started=Date.now()>new Date(c.scheduled_at).getTime();
  let html='';
  if(c.status==='cancel_requested') html+=`<div class="alert alert-yellow"><strong>‚ö† –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É / –ø–µ—Ä–µ–Ω–æ—Å</strong><br><span style="font-size:12px">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º. –ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é¬ª.</span></div>`;
  html+=`<div>
    <div class="d-row"><span class="d-label">–°—Ç–∞—Ç—É—Å</span><span class="d-value">${statusBadge(c.status)}</span></div>
    <div class="d-row"><span class="d-label">–í—Ä–∞—á</span><span class="d-value">${esc(c.doctor_name)}</span></div>
    <div class="d-row"><span class="d-label">–ü–∞—Ü–∏–µ–Ω—Ç</span><span class="d-value">${esc(c.patient_name)}</span></div>
    ${c.doctor_phone?`<div class="d-row"><span class="d-label">–¢–µ–ª. –≤—Ä–∞—á–∞</span><span class="d-value">${esc(c.doctor_phone)}</span></div>`:''}
    ${c.patient_phone?`<div class="d-row"><span class="d-label">–¢–µ–ª. –ø–∞—Ü–∏–µ–Ω—Ç–∞</span><span class="d-value">${esc(c.patient_phone)}</span></div>`:''}
  </div><hr class="d-sep">`;
  if(!expired&&c.status!=='cancelled'){
    html+=`<div><span class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞</span><div class="form-row">
      <input type="date" id="d-date" value="${c.scheduled_at.slice(0,10)}"/>
      <input type="time" id="d-time" value="${c.scheduled_at.slice(11,16)}"/>
    </div></div>`;
  } else {
    html+=`<div class="d-row"><span class="d-label">–î–∞—Ç–∞</span><span class="d-value">${fmtDate(c.scheduled_at)}</span></div>`;
  }
  [['–°—Å—ã–ª–∫–∞ ‚Äî –≤—Ä–∞—á',c.doctor_link],['–°—Å—ã–ª–∫–∞ ‚Äî –ø–∞—Ü–∏–µ–Ω—Ç',c.patient_link]].forEach(([l,u])=>{
    html+=`<div><span class="form-label">${l}</span><div class="link-box"><span class="link-url">${esc(u||'‚Äî')}</span>${u?`<button class="btn-copy" onclick="copyText('${esc(u)}')">‚éò</button>`:''}</div></div>`;
  });
  document.getElementById('detail-body').innerHTML=html;
  let acts='';
  if(!expired&&c.status!=='cancelled'){
    acts+=`<button class="btn btn-primary btn-full" onclick="saveC('${c.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
    if(!started) acts+=`<button class="btn btn-danger btn-full" onclick="showConfirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?','–ó–∞–ø–∏—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.',()=>deleteC('${c.id}'))">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
    acts+=`<button class="btn btn-secondary btn-full" onclick="showConfirm('–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?','–í—Ä–∞—á –∏ –ø–∞—Ü–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.',()=>cancelC('${c.id}'))">–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</button>`;
  }
  document.getElementById('detail-actions').innerHTML=acts;
  document.getElementById('detail-sidebar').classList.add('show');
}

// CRUD
function copyText(t){navigator.clipboard.writeText(t).then(()=>showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','success'));}
async function saveC(id){
  const d=document.getElementById('d-date')?.value;
  const t=document.getElementById('d-time')?.value;
  if(!d||!t) return;
  const {error}=await sb.from('consultations').update({scheduled_at:new Date(`${d}T${t}`).toISOString(),status:'scheduled'}).eq('id',id);
  if(error) showToast(error.message,'error');
  else{showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','success');loadConsultations();closeDetail();}
}
async function cancelC(id){
  await sb.from('consultations').update({status:'cancelled'}).eq('id',id);
  showToast('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞','info');loadConsultations();closeDetail();
}
async function deleteC(id){
  await sb.from('consultations').delete().eq('id',id);
  showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞','info');loadConsultations();closeDetail();
}

// CREATE MODAL
function openCreate(){
  const docs=JSON.parse(localStorage.getItem('tm_doctors')||'[]');
  document.getElementById('create-body').innerHTML=`
  <div class="form-col">
    <div class="form-group"><label class="form-label">–§–ò–û –≤—Ä–∞—á–∞ *</label>
      <input type="text" id="c-doc" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" list="c-docl"/>
      <datalist id="c-docl">${docs.map(d=>`<option value="${d}"></option>`).join('')}</datalist>
    </div>
    <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤—Ä–∞—á–∞</label><input type="tel" id="c-docph" placeholder="+7 700 000 00 00"/></div>
    <hr class="sep">
    <div class="form-group"><label class="form-label">–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞ *</label><input type="text" id="c-pat" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á"/></div>
    <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ü–∏–µ–Ω—Ç–∞</label><input type="tel" id="c-patph" placeholder="+7 700 000 00 00"/></div>
    <hr class="sep">
    <div class="form-row">
      <div class="form-group"><label class="form-label">–î–∞—Ç–∞ *</label><input type="date" id="c-date" value="${new Date().toISOString().slice(0,10)}"/></div>
      <div class="form-group"><label class="form-label">–í—Ä–µ–º—è *</label><input type="time" id="c-time" value="10:00"/></div>
    </div>
    <div id="c-alert" style="display:none"></div>
    <div class="modal-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeCreate()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" style="flex:2" onclick="createC()">–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏</button>
    </div>
  </div>`;
  document.getElementById('modal-create').classList.add('show');
}
function closeCreate(){document.getElementById('modal-create').classList.remove('show');}

async function createC(){
  const doc=document.getElementById('c-doc')?.value?.trim();
  const pat=document.getElementById('c-pat')?.value?.trim();
  const date=document.getElementById('c-date')?.value;
  const time=document.getElementById('c-time')?.value;
  if(!doc||!pat||!date||!time){setCAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');return;}
  const {data,error}=await sb.from('consultations').insert({
    doctor_name:doc,patient_name:pat,
    doctor_phone:document.getElementById('c-docph')?.value||null,
    patient_phone:document.getElementById('c-patph')?.value||null,
    scheduled_at:new Date(`${date}T${time}:00`).toISOString(),
    status:'scheduled',doctor_link:'',patient_link:'',
  }).select().single();
  if(error){setCAlert(error.message);return;}
  const base=window.location.origin+window.location.pathname;
  const dLink=`${base}?role=doctor&id=${data.id}`;
  const pLink=`${base}?role=patient&id=${data.id}`;
  await sb.from('consultations').update({doctor_link:dLink,patient_link:pLink}).eq('id',data.id);
  const docs=JSON.parse(localStorage.getItem('tm_doctors')||'[]');
  localStorage.setItem('tm_doctors',JSON.stringify([doc,...docs.filter(d=>d!==doc)].slice(0,30)));
  document.getElementById('create-body').innerHTML=`
  <div class="form-col">
    <div class="alert alert-success">‚úì –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞! –°—Å—ã–ª–∫–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç 3 —á–∞—Å–∞ —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞.</div>
    <div><span class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ä–∞—á–∞</span><div class="link-box"><span class="link-url">${esc(dLink)}</span><button class="btn-copy" onclick="copyText('${esc(dLink)}')">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>
    <div><span class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞</span><div class="link-box"><span class="link-url">${esc(pLink)}</span><button class="btn-copy" onclick="copyText('${esc(pLink)}')">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>
    <button class="btn btn-primary btn-full" onclick="closeCreate()">–ì–æ—Ç–æ–≤–æ</button>
  </div>`;
  loadConsultations();
}
function setCAlert(m){const el=document.getElementById('c-alert');if(!el)return;el.style.display=m?'':'none';el.className='alert alert-error';el.textContent=m;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCTOR CABINET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterDoctor(){
  document.getElementById('doctor-name').textContent=currentProfile?.full_name||'–í—Ä–∞—á';
  document.getElementById('doctor-specialty').textContent=currentProfile?.specialty||'–í—Ä–∞—á';
  showPage('doctor');
  const {data}=await sb.from('consultations').select('*').order('scheduled_at',{ascending:false});
  // Filter by doctor name (or doctor_id if set)
  const mine=(data||[]).filter(c=>c.doctor_id===currentUser.id||c.doctor_name===currentProfile?.full_name);
  renderDoctorList(mine);
}

function renderDoctorList(list){
  const el=document.getElementById('doctor-list');
  const active=list.filter(c=>!isExpired(c));
  const done=list.filter(c=>isExpired(c));
  if(!active.length&&!done.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üìã</div><div style="font-size:16px">–ü—Ä–∏—ë–º–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div><div style="font-size:13px;color:var(--dim)">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–∏—Ç –≤–∞–º –ø—Ä–∏—ë–º—ã</div></div>`;return;
  }
  el.innerHTML=[...active,...done].map(c=>{
    const exp=isExpired(c);
    const canJoin=isActive(c);
    const base=window.location.origin+window.location.pathname;
    const link=`${base}?role=doctor&id=${c.id}`;
    return `<div style="margin:16px 24px;background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:20px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">–ü–∞—Ü–∏–µ–Ω—Ç</div>
          <div style="color:var(--text);font-size:17px;font-weight:600">${esc(c.patient_name)}</div>
          <div style="color:var(--dim);font-size:13px;margin-top:4px">${fmtDate(c.scheduled_at)}</div>
        </div>
        ${statusBadge(c.status)}
      </div>
      ${canJoin?`<a href="${link}"><button class="btn btn-green btn-full">üé• –ù–∞—á–∞—Ç—å –ø—Ä–∏—ë–º</button></a>`:
        exp?`<div style="color:var(--muted);font-size:13px;padding:10px 0">–ü—Ä–∏—ë–º –∑–∞–≤–µ—Ä—à—ë–Ω</div>`:
        `<div style="color:var(--dim);font-size:13px;padding:10px 0">–ü—Ä–∏—ë–º –Ω–∞—á–Ω—ë—Ç—Å—è: ${fmtDate(c.scheduled_at)}</div>`}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATIENT CABINET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterPatientCab(){
  document.getElementById('patient-name').textContent=currentProfile?.full_name||'–ü–∞—Ü–∏–µ–Ω—Ç';
  showPage('patient-cab');
  const {data}=await sb.from('consultations').select('*').order('scheduled_at',{ascending:false});
  const mine=(data||[]).filter(c=>c.patient_id===currentUser.id||c.patient_name===currentProfile?.full_name);
  renderPatientList(mine);
}

function renderPatientList(list){
  const el=document.getElementById('patient-list');
  if(!list.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üè•</div><div style="font-size:16px">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div><div style="font-size:13px;color:var(--dim)">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É –¥–ª—è –∑–∞–ø–∏—Å–∏</div></div>`;return;
  }
  const base=window.location.origin+window.location.pathname;
  el.innerHTML=list.map(c=>{
    const canJoin=isActive(c);
    const exp=isExpired(c);
    const link=`${base}?role=patient&id=${c.id}`;
    return `<div style="margin:16px 24px;background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:20px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:12px">
        <div>
          <div style="color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">–í—Ä–∞—á</div>
          <div style="color:var(--text);font-size:17px;font-weight:600">${esc(c.doctor_name)}</div>
          <div style="color:var(--dim);font-size:13px;margin-top:4px">${fmtDate(c.scheduled_at)}</div>
        </div>
        ${statusBadge(c.status)}
      </div>
      ${canJoin?`<a href="${link}"><button class="btn btn-green btn-full">üé• –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button></a>`:
        exp?`<div style="color:var(--muted);font-size:13px;padding:10px 0">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>`:
        c.status==='cancelled'?`<div style="color:var(--red);font-size:13px;padding:10px 0">–û—Ç–º–µ–Ω–µ–Ω–∞</div>`:
        `<div style="color:var(--dim);font-size:13px;padding:10px 0">–ù–∞—á–∞–ª–æ: ${fmtDate(c.scheduled_at)}</div>`}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALL PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterCall(role,id){
  callRole=role; callId=id;
  chatMsgs=[]; unread=0; chatOpen=false; micOn=true; camOn=true;
  const {data:c}=await sb.from('consultations').select('*').eq('id',id).single();
  if(!c){showInfo('‚ùì','–ù–µ –Ω–∞–π–¥–µ–Ω–æ','–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É.');return;}
  if(c.status==='cancelled'){showInfo('‚ùå','–û—Ç–º–µ–Ω–µ–Ω–æ','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');return;}
  if(isExpired(c)){showInfo('‚è∞','–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ','–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç 3 —á–∞—Å–∞ —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞.');return;}
  if(!isActive(c)){
    // Waiting room
    document.getElementById('w-role-label').textContent=role==='patient'?'–í–∞—à–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è':'–ü—Ä–∏—ë–º –ø–∞—Ü–∏–µ–Ω—Ç–∞';
    document.getElementById('w-name').textContent=role==='patient'?`–í—Ä–∞—á: ${c.doctor_name}`:`–ü–∞—Ü–∏–µ–Ω—Ç: ${c.patient_name}`;
    document.getElementById('w-date').textContent=fmtDate(c.scheduled_at);
    showPage('waiting');
    startCD(c.scheduled_at,()=>enterCall(role,id));
    return;
  }
  stopCD();
  document.getElementById('call-peer-label').textContent=role==='patient'?`–í—Ä–∞—á: ${c.doctor_name}`:`–ü–∞—Ü–∏–µ–Ω—Ç: ${c.patient_name}`;
  document.getElementById('w-peer-text').textContent=`–û–∂–∏–¥–∞–µ–º ${role==='doctor'?'–ø–∞—Ü–∏–µ–Ω—Ç–∞':'–≤—Ä–∞—á–∞'}...`;
  document.getElementById('waiting-overlay').style.display='flex';
  document.getElementById('chat-msgs').innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;margin-top:48px">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É...</div>';
  document.getElementById('chat-panel').classList.remove('show');
  document.getElementById('chat-badge').style.display='none';
  document.getElementById('btn-mic').className='ctrl-btn';
  document.getElementById('btn-cam').className='ctrl-btn';
  document.getElementById('btn-chat').className='ctrl-btn';
  showPage('call');
  await startMedia();
  startSignaling(role,id,c);
}

function startCD(target,done){
  stopCD();
  function tick(){
    const diff=Math.max(0,new Date(target).getTime()-Date.now());
    document.getElementById('cd-h').textContent=pad(Math.floor(diff/3600000));
    document.getElementById('cd-m').textContent=pad(Math.floor((diff%3600000)/60000));
    document.getElementById('cd-s').textContent=pad(Math.floor((diff%60000)/1000));
    if(diff<=0&&done){stopCD();done();}
  }
  tick(); cdTimer=setInterval(tick,1000);
}
function stopCD(){if(cdTimer){clearInterval(cdTimer);cdTimer=null;}}

async function startMedia(){
  try{
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById('local-video').srcObject=localStream;
  }catch(e){showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É','error');}
}

function startSignaling(role,id,c){
  const peer=role==='patient'?'doctor':'patient';
  if(sigCh) sb.removeChannel(sigCh);
  sigCh=sb.channel(`sig_${id}`,{config:{presence:{key:role}}});
  sigCh.on('broadcast',{event:'signal'},async({payload})=>{
    if(payload.to!==role) return;
    const pc=peerConn; if(!pc) return;
    try{
      if(payload.offer){await pc.setRemoteDescription(payload.offer);const a=await pc.createAnswer();await pc.setLocalDescription(a);sigCh.send({type:'broadcast',event:'signal',payload:{to:peer,answer:a}});}
      if(payload.answer) await pc.setRemoteDescription(payload.answer);
      if(payload.ice) await pc.addIceCandidate(payload.ice);
    }catch(e){}
  });
  sigCh.on('broadcast',{event:'chat'},({payload})=>{
    chatMsgs.push(payload);appendMsg(payload);
    if(!chatOpen){unread++;updateBadge();}
  });
  sigCh.on('broadcast',{event:'end'},()=>showEndedPage());
  sigCh.on('presence',{event:'sync'},()=>{
    const state=sigCh.presenceState();
    const here=!!state[peer];
    document.getElementById('waiting-overlay').style.display=here?'none':'flex';
    if(here&&!peerConn) setupPC(role,peer);
  });
  sigCh.subscribe(async s=>{if(s!=='SUBSCRIBED') return; await sigCh.track({online:true});});
}

function setupPC(role,peer){
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  peerConn=pc;
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>{document.getElementById('remote-video').srcObject=e.streams[0];};
  pc.onicecandidate=e=>{if(e.candidate&&sigCh) sigCh.send({type:'broadcast',event:'signal',payload:{to:peer,ice:e.candidate}});};
  if(role==='doctor'){
    pc.createOffer().then(o=>{pc.setLocalDescription(o);sigCh.send({type:'broadcast',event:'signal',payload:{to:'patient',offer:o}});});
  }
}

function toggleMic(){
  micOn=!micOn;
  localStream?.getAudioTracks().forEach(t=>t.enabled=micOn);
  const b=document.getElementById('btn-mic');
  b.textContent=micOn?'üéô':'üîá'; b.className='ctrl-btn'+(micOn?'':' off');
}
function toggleCam(){
  camOn=!camOn;
  localStream?.getVideoTracks().forEach(t=>t.enabled=camOn);
  const b=document.getElementById('btn-cam');
  b.textContent=camOn?'üìπ':'üì∑'; b.className='ctrl-btn'+(camOn?'':' off');
}
function toggleChat(){
  chatOpen=!chatOpen; unread=0; updateBadge();
  const p=document.getElementById('chat-panel');
  chatOpen?p.classList.add('show'):p.classList.remove('show');
  document.getElementById('local-video-wrap').style.right=chatOpen?'376px':'16px';
  document.getElementById('btn-chat').className='ctrl-btn'+(chatOpen?' on':'');
  scrollChat();
}
function updateBadge(){const b=document.getElementById('chat-badge');if(unread>0&&!chatOpen){b.style.display='flex';b.textContent=unread;}else b.style.display='none';}
function sendMsg(){
  const inp=document.getElementById('chat-input');
  const text=inp.value.trim();
  if(!text||!sigCh) return;
  const m={from:callRole,text,ts:Date.now()};
  sigCh.send({type:'broadcast',event:'chat',payload:m});
  chatMsgs.push(m); appendMsg(m); inp.value='';
}
function appendMsg(m){
  const c=document.getElementById('chat-msgs');
  const empty=c.querySelector('div[style*="margin-top:48px"]');
  if(empty) empty.remove();
  const mine=m.from===callRole;
  const d=document.createElement('div');
  d.className='msg-wrap'+(mine?' mine':'');
  d.innerHTML=`<div class="bubble ${mine?'mine':'theirs'}">
    ${!mine?`<div class="bubble-from">${m.from==='doctor'?'–í—Ä–∞—á':'–ü–∞—Ü–∏–µ–Ω—Ç'}</div>`:''}
    ${esc(m.text)}
    <div class="bubble-time ${mine?'mine':'theirs'}">${new Date(m.ts).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}</div>
  </div>`;
  c.appendChild(d); scrollChat();
}
function scrollChat(){const c=document.getElementById('chat-msgs');c.scrollTop=c.scrollHeight;}
async function endCall(){
  sigCh?.send({type:'broadcast',event:'end',payload:{}});
  if(callRole==='doctor') await sb.from('consultations').update({status:'completed'}).eq('id',callId);
  cleanCall(); showEndedPage();
}
function cleanCall(){
  localStream?.getTracks().forEach(t=>t.stop());
  peerConn?.close();
  localStream=null; peerConn=null;
  if(sigCh){sb.removeChannel(sigCh);sigCh=null;}
}
function showEndedPage(){
  cleanCall();
  document.getElementById('ended-text').textContent=callRole==='patient'?'–°–ø–∞—Å–∏–±–æ! –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–∞ email.':'–ü—Ä–∏—ë–º –∑–∞–≤–µ—Ä—à—ë–Ω.';
  const sec=document.getElementById('ended-email-sec');
  sec.style.display=(callRole==='patient'&&chatMsgs.length>0)?'flex':'none';
  document.getElementById('ended-sent').style.display='none';
  showPage('ended');
}
function sendHistory(){
  const email=document.getElementById('ended-email').value;
  if(!email) return;
  document.getElementById('ended-sent').textContent=`‚úì –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –Ω–∞ ${email} —á–µ—Ä–µ–∑ Supabase Edge Function`;
  document.getElementById('ended-sent').style.display='block';
  document.getElementById('ended-email-sec').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  showPage('loading');
  const params=new URLSearchParams(window.location.search);
  const role=params.get('role');
  const id=params.get('id');

  // Call pages ‚Äî no auth needed
  if(role&&id){await enterCall(role,id);return;}

  const {data:{session}}=await sb.auth.getSession();
  if(session){
    await loadProfile();
    routeByRole();
  } else {
    showPage('auth');
  }

  sb.auth.onAuthStateChange(async(_,s)=>{
    if(role&&id) return; // ignore on call pages
    if(s){await loadProfile();routeByRole();}
    else{currentUser=null;currentProfile=null;showPage('auth');}
  });
}

init();
</script>
</body>
</html>
