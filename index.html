<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TeleMed ‚Äî –ú–æ–¥—É–ª—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: 'IBM Plex Sans', sans-serif;
  background: #080d1a;
  color: #f1f5f9;
  -webkit-font-smoothing: antialiased;
}
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: #080d1a; }
::-webkit-scrollbar-thumb { background: #263350; border-radius: 4px; }

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp  { from { opacity:0; transform:translateY(18px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn  { from { opacity:0; } to { opacity:1; } }
@keyframes popIn   { from { opacity:0; transform:scale(.92); } to { opacity:1; transform:scale(1); } }
@keyframes spin    { to { transform:rotate(360deg); } }
@keyframes pulse   { 0%,100%{opacity:1} 50%{opacity:.3} }
@keyframes tick    { from{transform:scale(1.12)} to{transform:scale(1)} }
.fade-up  { animation: fadeUp  .45s cubic-bezier(.22,1,.36,1) both; }
.fade-in  { animation: fadeIn  .3s ease both; }
.pop-in   { animation: popIn   .3s cubic-bezier(.34,1.56,.64,1) both; }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; min-height: 100vh; }
.page.active { display: flex; flex-direction: column; }

/* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
#page-loading {
  align-items: center; justify-content: center;
  background: #080d1a;
}
.spinner {
  width: 42px; height: 42px;
  border: 3px solid #263350;
  border-top-color: #6366f1;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}

/* ‚îÄ‚îÄ LOGIN PAGE ‚îÄ‚îÄ */
#page-login {
  flex-direction: row;
  background: radial-gradient(ellipse at 70% 20%, #1e1b4b88, #080d1a 65%);
}
.login-left {
  flex: 1;
  display: flex; flex-direction: column;
  justify-content: center;
  padding: 60px 80px;
  border-right: 1px solid #1e293b;
}
.login-right {
  width: 440px;
  display: flex; align-items: center; justify-content: center;
  padding: 40px;
}
.login-card {
  width: 100%;
  background: #141e33;
  border: 1px solid #263350;
  border-radius: 20px;
  padding: 36px;
  box-shadow: 0 24px 80px #0008;
}
.logo-wrap { display: flex; align-items: center; gap: 12px; margin-bottom: 0; }
.logo-icon {
  width: 52px; height: 52px; border-radius: 15px;
  background: linear-gradient(135deg,#6366f1,#8b5cf6);
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; flex-shrink: 0;
}
.logo-icon-sm {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg,#6366f1,#8b5cf6);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.logo-name {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 28px; font-weight: 700; color: #f1f5f9; line-height: 1.1;
}
.logo-name-sm { font-size: 17px; }
.logo-sub { color: #64748b; font-size: 11px; margin-top: 2px; }
.login-title {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 38px; color: #f1f5f9; line-height: 1.2;
  margin: 56px 0 18px;
}
.login-title span { color: #6366f1; }
.login-desc { color: #64748b; font-size: 15px; line-height: 1.8; max-width: 420px; }
.feature-list { margin-top: 52px; display: flex; flex-direction: column; gap: 18px; }
.feature-item { display: flex; align-items: center; gap: 14px; }
.feature-icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: #6366f118;
  display: flex; align-items: center; justify-content: center; font-size: 18px;
  flex-shrink: 0;
}
.feature-text { color: #475569; font-size: 14px; }
.card-title {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 22px; color: #f1f5f9; margin-bottom: 6px;
}
.card-sub { color: #64748b; font-size: 13px; margin-bottom: 28px; }
.form-col { display: flex; flex-direction: column; gap: 14px; }

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
input, select {
  font-family: 'IBM Plex Sans', sans-serif;
  width: 100%; padding: 11px 14px;
  border-radius: 10px;
  background: #0f172a; border: 1px solid #263350;
  color: #f1f5f9; font-size: 14px; outline: none;
  transition: border-color .2s;
}
input:focus, select:focus { border-color: #6366f1; }
input[type="date"], input[type="time"] { color-scheme: dark; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-label { color: #64748b; font-size: 12px; font-weight: 500; margin-bottom: 6px; display: block; }
.form-group { display: flex; flex-direction: column; }
hr.sep { border: none; border-top: 1px solid #1e293b; margin: 2px 0; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
button { font-family: 'IBM Plex Sans', sans-serif; cursor: pointer; transition: filter .15s, transform .1s; border: none; }
button:hover:not(:disabled) { filter: brightness(1.1); }
button:active:not(:disabled) { transform: scale(.97); }
button:disabled { opacity: .5; cursor: not-allowed; }
.btn {
  padding: 11px 22px; border-radius: 10px;
  font-size: 14px; font-weight: 600; line-height: 1;
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-primary { background: linear-gradient(135deg,#6366f1,#8b5cf6); color: #fff; border: none; }
.btn-secondary { background: transparent; color: #64748b; border: 1px solid #263350; }
.btn-danger { background: transparent; color: #ef4444; border: 1px solid #ef444466; }
.btn-red { background: #ef4444; color: #fff; border: none; }
.btn-ghost { background: transparent; color: #64748b; border: none; }
.btn-full { width: 100%; }
.btn-link { background: none; border: none; color: #6366f1; font-size: 13px; text-decoration: underline; text-underline-offset: 3px; font-family: inherit; }

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.alert { padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-bottom: 4px; }
.alert-error   { background: #ef444418; border: 1px solid #ef444444; color: #fca5a5; }
.alert-success { background: #10b98118; border: 1px solid #10b98144; color: #10b981; }
.alert-info    { background: #3b82f618; border: 1px solid #3b82f644; color: #3b82f6; }
.alert-yellow  { background: #f59e0b11; border: 1px solid #f59e0b44; color: #f59e0b; }

/* ‚îÄ‚îÄ STATUS BADGE ‚îÄ‚îÄ */
.badge {
  display: inline-block;
  padding: 3px 10px; border-radius: 6px;
  font-size: 11px; font-weight: 600; letter-spacing: .04em;
  white-space: nowrap;
}
.badge-blue   { background:#3b82f622; color:#3b82f6; border:1px solid #3b82f644; }
.badge-yellow { background:#f59e0b22; color:#f59e0b; border:1px solid #f59e0b44; }
.badge-red    { background:#ef444422; color:#ef4444; border:1px solid #ef444444; }
.badge-green  { background:#10b98122; color:#10b981; border:1px solid #10b98144; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 9999;
  background: #141e33; border-radius: 12px;
  padding: 14px 20px; max-width: 360px;
  box-shadow: 0 16px 48px #000a;
  display: none; align-items: center; gap: 12px; font-size: 14px;
}
#toast.show { display: flex; animation: popIn .3s ease; }
.toast-icon {
  width: 24px; height: 24px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 12px; flex-shrink: 0;
}
#toast-close { background: none; border: none; color: #64748b; font-size: 18px; margin-left: 8px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: #00000099;
  align-items: center; justify-content: center; z-index: 1000;
  backdrop-filter: blur(6px); padding: 24px;
}
.modal-overlay.show { display: flex; animation: fadeIn .25s ease; }
.modal-box {
  background: #0f172a; border: 1px solid #263350;
  border-radius: 18px; padding: 32px; width: 100%; max-width: 480px;
  box-shadow: 0 32px 96px #000b;
  animation: popIn .3s cubic-bezier(.34,1.56,.64,1);
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.modal-title { font-family:'Playfair Display',Georgia,serif; font-size: 17px; color: #f1f5f9; }
.modal-close { background: none; border: none; color: #64748b; font-size: 22px; }
.modal-btns { display: flex; gap: 10px; margin-top: 24px; }

/* ‚îÄ‚îÄ ADMIN LAYOUT ‚îÄ‚îÄ */
#page-admin { flex-direction: row; height: 100vh; overflow: hidden; }
.admin-sidebar {
  width: 260px; background: #0f172a;
  border-right: 1px solid #1e293b;
  display: flex; flex-direction: column; flex-shrink: 0;
}
.sidebar-brand { padding: 24px 20px 20px; border-bottom: 1px solid #1e293b; }
.sidebar-user { padding: 16px 20px; border-bottom: 1px solid #1e293b; }
.user-email { color: #f1f5f9; font-size: 13px; margin-bottom: 2px; }
.user-role { color: #64748b; font-size: 11px; margin-bottom: 10px; }
.btn-logout {
  background: none; border: 1px solid #263350; border-radius: 7px;
  padding: 5px 12px; color: #64748b; font-size: 12px;
}
.sidebar-stats { padding: 16px; border-bottom: 1px solid #1e293b; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-card {
  background: #141e33; border: 1px solid #1e293b;
  border-radius: 9px; padding: 12px 14px;
}
.stat-num { font-size: 22px; font-weight: 700; line-height: 1; }
.stat-label { color: #64748b; font-size: 10px; margin-top: 4px; }
.sidebar-nav { padding: 12px; flex: 1; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 9px;
  font-size: 13px; font-weight: 500; cursor: pointer;
  background: #6366f120; color: #a5b4fc;
}
.admin-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.admin-topbar {
  padding: 16px 28px; border-bottom: 1px solid #1e293b;
  display: flex; align-items: center; gap: 16px;
  background: #0f172a; flex-shrink: 0;
}
.topbar-title {
  flex: 1; font-family:'Playfair Display',Georgia,serif;
  font-size: 20px; color: #f1f5f9;
}
.admin-filters {
  padding: 12px 28px; border-bottom: 1px solid #1e293b;
  display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
  background: #0f172a; flex-shrink: 0;
}
.filter-search { flex: 1; min-width: 200px; }
.filter-date { width: 170px; }
.filter-status { width: auto; }
.admin-content { flex: 1; display: flex; overflow: hidden; }
.consult-list { flex: 1; overflow-y: auto; }

/* ‚îÄ‚îÄ CONSULTATION ROW ‚îÄ‚îÄ */
.consult-row {
  padding: 14px 24px; border-bottom: 1px solid #1e293b;
  cursor: pointer; transition: background .15s;
  display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
}
.consult-row:hover { background: #141e33; }
.consult-row.selected { background: #141e33; }
.row-patient { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap; }
.row-patient-name { color: #f1f5f9; font-size: 14px; font-weight: 500; }
.row-doctor { color: #475569; font-size: 12px; margin-bottom: 2px; }
.row-date { color: #64748b; font-size: 11px; }
.row-arrow { color: #64748b; }
.section-toggle {
  padding: 10px 24px; background: #141e33;
  border-top: 1px solid #1e293b; border-bottom: 1px solid #1e293b;
  cursor: pointer; display: flex; justify-content: space-between;
  color: #475569; font-size: 13px;
}
.empty-state {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  height: 320px; gap: 12px; color: #64748b;
}
.empty-icon { font-size: 52px; }
.empty-text { font-size: 16px; }
.empty-sub  { font-size: 13px; color: #475569; }

/* ‚îÄ‚îÄ DETAIL SIDEBAR ‚îÄ‚îÄ */
.detail-sidebar {
  width: 360px; background: #0f172a;
  border-left: 1px solid #1e293b;
  display: none; flex-direction: column; flex-shrink: 0;
}
.detail-sidebar.show { display: flex; animation: fadeIn .25s ease; }
.detail-header {
  padding: 18px 24px; border-bottom: 1px solid #1e293b;
  display: flex; justify-content: space-between; align-items: center;
}
.detail-title { color: #f1f5f9; font-size: 15px; font-weight: 600; }
.detail-close { background: none; border: none; color: #64748b; font-size: 22px; }
.detail-body { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
.detail-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; padding: 7px 0; }
.detail-label { color: #64748b; font-size: 13px; flex-shrink: 0; }
.detail-value { color: #f1f5f9; font-size: 13px; text-align: right; }
.detail-sep { border: none; border-top: 1px solid #1e293b; }
.link-box {
  background: #141e33; border: 1px solid #263350;
  border-radius: 9px; padding: 12px;
  display: flex; gap: 10px; align-items: flex-start;
}
.link-url {
  font-family: 'IBM Plex Mono', monospace;
  color: #a5b4fc; font-size: 11px; word-break: break-all; flex: 1;
}
.btn-copy {
  background: #263350; border: none; border-radius: 6px;
  padding: 4px 10px; color: #f1f5f9; font-size: 11px; flex-shrink: 0;
}
.detail-actions {
  padding: 16px 24px 24px; border-top: 1px solid #1e293b;
  display: flex; flex-direction: column; gap: 10px;
}

/* ‚îÄ‚îÄ WAITING PAGE ‚îÄ‚îÄ */
#page-waiting {
  align-items: center; justify-content: center;
  background: radial-gradient(ellipse at 50% 10%, #1e1b4b55, #080d1a 70%);
  padding: 24px; gap: 36px;
}
.waiting-card {
  background: #141e33; border: 1px solid #263350;
  border-radius: 20px; padding: 44px; max-width: 520px; width: 100%;
  text-align: center;
}
.waiting-label { color: #64748b; font-size: 13px; font-weight: 500; margin-bottom: 8px; }
.waiting-name {
  font-family:'Playfair Display',Georgia,serif;
  font-size: 24px; color: #f1f5f9; margin-bottom: 6px;
}
.waiting-date { color: #475569; font-size: 15px; margin-bottom: 40px; }
.countdown-wrap { margin-bottom: 36px; }
.countdown-label { color: #64748b; font-size: 13px; margin-bottom: 20px; }
.countdown {
  display: flex; align-items: center; justify-content: center; gap: 16px;
}
.countdown-unit { text-align: center; }
.countdown-num {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 56px; font-weight: 700; color: #f1f5f9; line-height: 1;
}
.countdown-unit-label { color: #64748b; font-size: 12px; margin-top: 6px; }
.countdown-sep { font-family: monospace; font-size: 44px; color: #6366f1; line-height: 1; opacity: .6; }

/* ‚îÄ‚îÄ CALL PAGE ‚îÄ‚îÄ */
#page-call {
  position: relative; overflow: hidden;
  background: #000; min-height: 100vh;
}
#page-call.active { display: block; }
#remote-video { width: 100%; height: 100vh; object-fit: cover; display: block; }
#local-video-wrap {
  position: absolute; top: 16px; right: 16px;
  width: 180px; border-radius: 12px; overflow: hidden;
  border: 2px solid #263350;
  box-shadow: 0 8px 32px #000b;
  transition: right .3s ease;
}
#local-video { width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block; }
.call-peer-label {
  position: absolute; top: 16px; left: 16px;
  background: #00000088; backdrop-filter: blur(8px);
  border-radius: 10px; padding: 8px 14px;
  color: #ffffffcc; font-size: 13px;
}
.call-controls {
  position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%);
  display: flex; gap: 14px; align-items: center;
}
.ctrl-btn {
  width: 52px; height: 52px; border-radius: 50%;
  background: #ffffff22; border: 1px solid #ffffff33;
  backdrop-filter: blur(8px);
  color: #fff; font-size: 22px;
  display: flex; align-items: center; justify-content: center;
  position: relative;
}
.ctrl-btn.off { background: #ef4444cc; border-color: #ef4444; }
.ctrl-btn.active { background: #6366f1cc; border-color: #6366f1; }
.ctrl-badge {
  position: absolute; top: -4px; right: -4px;
  background: #ef4444; color: #fff;
  width: 18px; height: 18px; border-radius: 50%;
  font-size: 10px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
}
.btn-end {
  width: 64px; height: 64px; border-radius: 50%;
  background: #ef4444; border: none;
  color: #fff; font-size: 26px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 24px #ef444488;
}
.waiting-overlay {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: #000c;
}
.waiting-overlay .spinner { animation: spin .8s linear infinite, pulse 2s ease infinite; }

/* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
#chat-panel {
  position: absolute; right: 0; top: 0; bottom: 0; width: 360px;
  background: #0f172aee; backdrop-filter: blur(16px);
  border-left: 1px solid #263350;
  display: none; flex-direction: column;
}
#chat-panel.show { display: flex; animation: fadeIn .25s ease; }
.chat-header {
  padding: 16px 20px; border-bottom: 1px solid #1e293b;
  display: flex; justify-content: space-between; align-items: center;
}
.chat-title { color: #f1f5f9; font-weight: 600; }
.chat-close { background: none; border: none; color: #64748b; font-size: 20px; }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
.chat-empty { color: #64748b; font-size: 13px; text-align: center; margin-top: 48px; }
.msg-wrap { display: flex; }
.msg-wrap.mine { justify-content: flex-end; }
.msg-bubble {
  max-width: 76%; padding: 9px 13px; border-radius: 12px;
  font-size: 14px; line-height: 1.5; color: #f1f5f9;
}
.msg-bubble.mine {
  background: #6366f1; border: 1px solid #8b5cf6;
  border-bottom-right-radius: 3px;
}
.msg-bubble.theirs {
  background: #141e33; border: 1px solid #263350;
  border-bottom-left-radius: 3px;
}
.msg-from { color: #a5b4fc; font-size: 11px; font-weight: 600; margin-bottom: 4px; }
.msg-time { font-size: 10px; margin-top: 4px; text-align: right; }
.msg-time.mine { color: #ffffffaa; }
.msg-time.theirs { color: #64748b; }
.chat-input-wrap {
  padding: 16px; border-top: 1px solid #1e293b;
  display: flex; gap: 10px;
}
#chat-input { flex: 1; }

/* ‚îÄ‚îÄ ENDED / INFO SCREENS ‚îÄ‚îÄ */
#page-ended, #page-info {
  align-items: center; justify-content: center;
  padding: 24px;
}
.info-card {
  background: #141e33; border: 1px solid #263350;
  border-radius: 20px; padding: 52px; max-width: 440px; width: 100%;
  text-align: center;
}
.info-icon { font-size: 56px; margin-bottom: 20px; }
.info-title {
  font-family:'Playfair Display',Georgia,serif;
  font-size: 22px; color: #f1f5f9; margin-bottom: 12px;
}
.info-text { color: #64748b; font-size: 14px; line-height: 1.7; }
.ended-card {
  background: #141e33; border: 1px solid #263350;
  border-radius: 20px; padding: 48px; max-width: 480px; width: 100%;
  text-align: center;
}
.ended-email-wrap { display: flex; flex-direction: column; gap: 12px; max-width: 320px; margin: 24px auto 0; }

@media (max-width: 900px) {
  .login-left { display: none; }
  #page-login { justify-content: center; }
  .login-right { width: 100%; max-width: 440px; }
  .admin-sidebar { width: 220px; }
  .detail-sidebar { width: 320px; }
}
@media (max-width: 640px) {
  .admin-sidebar { display: none; }
  .login-right { padding: 20px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê -->
<div id="page-loading" class="page active">
  <div class="spinner"></div>
</div>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div id="page-login" class="page">
  <div class="login-left fade-up">
    <div class="logo-wrap">
      <div class="logo-icon">üè•</div>
      <div>
        <div class="logo-name">TeleMed</div>
        <div class="logo-sub">–ú–æ–¥—É–ª—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã</div>
      </div>
    </div>
    <h1 class="login-title">–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏<br><span>–¥–ª—è –≤–∞—à–µ–π –∫–ª–∏–Ω–∏–∫–∏</span></h1>
    <p class="login-desc">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –≤—ã–¥–∞–≤–∞–π—Ç–µ —Å—Å—ã–ª–∫–∏ –≤—Ä–∞—á—É –∏ –ø–∞—Ü–∏–µ–Ω—Ç—É, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ –≤–∏–¥–µ–æ–ø—Ä–∏—ë–º—ã ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
    <div class="feature-list">
      <div class="feature-item"><div class="feature-icon">üìÖ</div><span class="feature-text">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏—ë–º–æ–≤</span></div>
      <div class="feature-item"><div class="feature-icon">üîó</div><span class="feature-text">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</span></div>
      <div class="feature-item"><div class="feature-icon">üì±</div><span class="feature-text">SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 1 —á–∞—Å</span></div>
      <div class="feature-item"><div class="feature-icon">üí≥</div><span class="feature-text">–û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥</span></div>
      <div class="feature-item"><div class="feature-icon">üé•</div><span class="feature-text">–ó–∞—â–∏—â—ë–Ω–Ω—ã–π WebRTC –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</span></div>
    </div>
  </div>
  <div class="login-right">
    <div class="login-card fade-up">
      <h2 class="card-title" id="login-form-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
      <p class="card-sub" id="login-form-sub">–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
      <div class="form-col">
        <input type="email" id="login-email" placeholder="Email" />
        <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" />
        <div id="login-alert" style="display:none"></div>
        <button class="btn btn-primary btn-full" style="padding:13px 0; margin-top:4px;" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <button class="btn-link" onclick="toggleResetMode()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<div id="page-admin" class="page">
  <div class="admin-sidebar">
    <div class="sidebar-brand">
      <div class="logo-wrap">
        <div class="logo-icon-sm">üè•</div>
        <div>
          <div class="logo-name logo-name-sm">TeleMed</div>
          <div class="logo-sub">–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        </div>
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-email" id="sidebar-email">‚Äî</div>
      <div class="user-role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
      <button class="btn btn-logout" onclick="doLogout()">–í—ã–π—Ç–∏</button>
    </div>
    <div class="sidebar-stats">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-num" id="stat-active" style="color:#6366f1">0</div><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-done"   style="color:#10b981">0</div><div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-req"    style="color:#f59e0b">0</div><div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-cancel" style="color:#ef4444">0</div><div class="stat-label">–û—Ç–º–µ–Ω–µ–Ω–æ</div></div>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item">üìã –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</div>
    </div>
  </div>

  <div class="admin-main">
    <div class="admin-topbar">
      <h1 class="topbar-title">–û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</h1>
      <button class="btn btn-primary" onclick="openCreateModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div class="admin-filters">
      <input class="filter-search" type="text" id="filter-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Ä–∞—á—É –∏–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç—É..." oninput="renderList()" />
      <input class="filter-date" type="date" id="filter-date" onchange="renderList()" />
      <select id="filter-status" onchange="renderList()">
        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="scheduled">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
        <option value="cancel_requested">–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É</option>
        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
      </select>
      <button class="btn btn-ghost" id="filter-reset" onclick="resetFilters()" style="display:none;font-size:13px;padding:10px 14px;">‚úï –°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div class="admin-content">
      <div class="consult-list" id="consult-list">
        <div class="empty-state"><div class="spinner"></div></div>
      </div>
      <div class="detail-sidebar" id="detail-sidebar">
        <div class="detail-header">
          <span class="detail-title">–î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏</span>
          <button class="detail-close" onclick="closeDetail()">√ó</button>
        </div>
        <div class="detail-body" id="detail-body"></div>
        <div class="detail-actions" id="detail-actions"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê WAITING ‚ïê‚ïê‚ïê -->
<div id="page-waiting" class="page">
  <div class="logo-wrap fade-up">
    <div class="logo-icon">üè•</div>
    <div>
      <div class="logo-name">TeleMed</div>
      <div class="logo-sub">–ú–æ–¥—É–ª—å —Ç–µ–ª–µ–º–µ–¥–∏—Ü–∏–Ω—ã</div>
    </div>
  </div>
  <div class="waiting-card fade-up">
    <div class="waiting-label" id="waiting-role-label">–í–∞—à–∞ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</div>
    <h2 class="waiting-name" id="waiting-name">‚Äî</h2>
    <div class="waiting-date" id="waiting-date">‚Äî</div>
    <div class="countdown-wrap">
      <div class="countdown-label">–î–æ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:</div>
      <div class="countdown">
        <div class="countdown-unit"><div class="countdown-num" id="cd-h">00</div><div class="countdown-unit-label">—á–∞—Å–æ–≤</div></div>
        <div class="countdown-sep">:</div>
        <div class="countdown-unit"><div class="countdown-num" id="cd-m">00</div><div class="countdown-unit-label">–º–∏–Ω—É—Ç</div></div>
        <div class="countdown-sep">:</div>
        <div class="countdown-unit"><div class="countdown-num" id="cd-s">00</div><div class="countdown-unit-label">—Å–µ–∫—É–Ω–¥</div></div>
      </div>
    </div>
    <div class="alert alert-info" style="text-align:left;line-height:1.7">
      –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏—ë–º–∞.<br>
      –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É, –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–æ—Å–∏—Ç.
    </div>
    <div id="payment-block" style="display:none;margin-top:20px;" class="alert alert-success" style="text-align:left">
      <strong>üí≥ –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞</strong><br>
      <span style="font-size:12px;line-height:1.7">–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –ê–ª—å—Ñ–∞-–±–∞–Ω–∫–∞ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã.</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CALL ‚ïê‚ïê‚ïê -->
<div id="page-call" class="page" style="display:none;position:relative;min-height:100vh;background:#000;">
  <video id="remote-video" autoplay playsinline style="width:100%;height:100vh;object-fit:cover;display:block;"></video>
  <div id="waiting-overlay" class="waiting-overlay">
    <div class="spinner" style="width:44px;height:44px;animation:spin .8s linear infinite;"></div>
    <p style="color:#64748b;margin-top:20px;font-size:15px;" id="waiting-peer-text">–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
  </div>
  <div id="local-video-wrap">
    <video id="local-video" autoplay playsinline muted></video>
    <div id="cam-off-overlay" style="display:none;position:absolute;inset:0;background:#141e33;display:none;align-items:center;justify-content:center;font-size:26px;color:#64748b;">üì∑</div>
  </div>
  <div class="call-peer-label" id="call-peer-label">‚Äî</div>
  <div class="call-controls">
    <div style="position:relative">
      <button class="ctrl-btn" id="btn-mic" onclick="toggleMic()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üéô</button>
    </div>
    <div style="position:relative">
      <button class="ctrl-btn" id="btn-cam" onclick="toggleCam()" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
    </div>
    <div style="position:relative">
      <button class="ctrl-btn" id="btn-chat" onclick="toggleChat()" title="–ß–∞—Ç">üí¨</button>
      <div class="ctrl-badge" id="chat-badge" style="display:none">0</div>
    </div>
    <button class="btn-end" onclick="endCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">üìµ</button>
  </div>
  <div id="chat-panel">
    <div class="chat-header">
      <span class="chat-title">–ß–∞—Ç</span>
      <button class="chat-close" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-empty">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É...</div>
    </div>
    <div class="chat-input-wrap">
      <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMsg()" />
      <button class="btn btn-primary" style="padding:11px 16px;" onclick="sendMsg()">‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ENDED ‚ïê‚ïê‚ïê -->
<div id="page-ended" class="page">
  <div class="ended-card fade-up">
    <div class="info-icon">‚úÖ</div>
    <h2 class="info-title">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
    <p class="info-text" id="ended-text">–°–ø–∞—Å–∏–±–æ! –ü—Ä–∏—ë–º —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.</p>
    <div id="ended-email-section" style="display:none" class="ended-email-wrap">
      <input type="email" id="ended-email" placeholder="–í–∞—à email –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞" />
      <button class="btn btn-primary btn-full" onclick="sendChatHistory()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞</button>
    </div>
    <p id="ended-sent" style="display:none;color:#10b981;font-size:13px;margin-top:12px;"></p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê INFO ‚ïê‚ïê‚ïê -->
<div id="page-info" class="page">
  <div class="info-card fade-up">
    <div class="info-icon" id="info-icon">‚ÑπÔ∏è</div>
    <h2 class="info-title" id="info-title">‚Äî</h2>
    <p class="info-text" id="info-text">‚Äî</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->

<!-- Create consultation modal -->
<div class="modal-overlay" id="modal-create">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">–ù–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</span>
      <button class="modal-close" onclick="closeCreateModal()">√ó</button>
    </div>
    <div id="modal-create-body">
      <div class="form-col">
        <div class="form-group"><label class="form-label">–§–ò–û –≤—Ä–∞—á–∞ *</label>
          <input type="text" id="c-doctor" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" list="doc-list" />
          <datalist id="doc-list"></datalist>
        </div>
        <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤—Ä–∞—á–∞</label>
          <input type="tel" id="c-doctor-phone" placeholder="+7 700 000 00 00" />
        </div>
        <hr class="sep">
        <div class="form-group"><label class="form-label">–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞ *</label>
          <input type="text" id="c-patient" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á" />
        </div>
        <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
          <input type="tel" id="c-patient-phone" placeholder="+7 700 000 00 00" />
        </div>
        <hr class="sep">
        <div class="form-row">
          <div class="form-group"><label class="form-label">–î–∞—Ç–∞ *</label><input type="date" id="c-date" /></div>
          <div class="form-group"><label class="form-label">–í—Ä–µ–º—è *</label><input type="time" id="c-time" value="10:00" /></div>
        </div>
        <div id="create-alert" style="display:none"></div>
        <div class="modal-btns">
          <button class="btn btn-secondary" style="flex:1" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" style="flex:2" id="btn-create" onclick="createConsultation()">–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏—ë–º</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div class="modal-overlay" id="modal-confirm">
  <div class="modal-box" style="max-width:400px">
    <div class="modal-header">
      <span class="modal-title" id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
      <button class="modal-close" onclick="closeConfirm()">√ó</button>
    </div>
    <p id="confirm-text" style="color:#64748b;font-size:14px;line-height:1.6"></p>
    <div class="modal-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeConfirm()">–ù–µ—Ç</button>
      <button class="btn btn-red" style="flex:1" id="confirm-ok">–î–∞</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast">
  <div class="toast-icon" id="toast-icon"></div>
  <span id="toast-msg"></span>
  <button id="toast-close" onclick="hideToast()">√ó</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL      = 'https://klskklkgltlkbnimhuna.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_6Rar90QvqMtOrqboEJWFpQ_YYr3r_KL';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let consultations  = [];
let selectedId     = null;
let showCompleted  = false;
let realtimeChannel = null;
let countdownTimer = null;
let callRole       = null;  // 'doctor' | 'patient'
let callConsultId  = null;
let localStream    = null;
let peerConn       = null;
let sigChannel     = null;
let chatMessages   = [];
let chatOpen       = false;
let unreadCount    = 0;
let micOn          = true;
let camOn          = true;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pad = n => String(n).padStart(2,'0');

function fmtDate(d) {
  return new Date(d).toLocaleString('ru-RU',{
    day:'2-digit', month:'long', year:'numeric',
    hour:'2-digit', minute:'2-digit'
  });
}

function isExpired(c) {
  if (!c) return false;
  if (c.status==='cancelled'||c.status==='completed') return true;
  return Date.now() > new Date(c.scheduled_at).getTime() + 3*60*60*1000;
}

function isActiveNow(c) {
  if (!c) return false;
  const start = new Date(c.scheduled_at).getTime();
  return Date.now() >= start && Date.now() < start + 3*60*60*1000;
}

function statusBadge(status) {
  const map = {
    scheduled:        ['–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ',    'badge-blue'  ],
    cancel_requested: ['–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É', 'badge-yellow'],
    cancelled:        ['–û—Ç–º–µ–Ω–µ–Ω–æ',          'badge-red'   ],
    completed:        ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ',          'badge-green' ],
  };
  const [label, cls] = map[status] || map.scheduled;
  return `<span class="badge ${cls}">${label}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
    p.style.display = '';
  });
  const el = document.getElementById('page-' + id);
  if (el) {
    el.classList.add('active');
    if (id === 'call') el.style.display = 'block';
  }
}

function showInfo(icon, title, text) {
  document.getElementById('info-icon').textContent  = icon;
  document.getElementById('info-title').textContent = title;
  document.getElementById('info-text').textContent  = text;
  showPage('info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer = null;
function showToast(msg, type='info') {
  const colors = { success:'#10b981', error:'#ef4444', info:'#3b82f6' };
  const icons  = { success:'‚úì', error:'‚úï', info:'‚Ñπ' };
  const t = document.getElementById('toast');
  document.getElementById('toast-msg').textContent = msg;
  document.getElementById('toast-icon').textContent = icons[type]||'‚Ñπ';
  t.style.border = `1px solid ${(colors[type]||colors.info)}44`;
  document.getElementById('toast-icon').style.background = (colors[type]||colors.info)+'22';
  document.getElementById('toast-icon').style.color = colors[type]||colors.info;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(hideToast, 4000);
}
function hideToast() {
  document.getElementById('toast').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCreateModal() {
  document.getElementById('c-doctor').value = '';
  document.getElementById('c-patient').value = '';
  document.getElementById('c-doctor-phone').value = '';
  document.getElementById('c-patient-phone').value = '';
  document.getElementById('c-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('c-time').value = '10:00';
  document.getElementById('create-alert').style.display = 'none';
  // Load doctor suggestions
  const docs = JSON.parse(localStorage.getItem('tm_doctors')||'[]');
  const dl = document.getElementById('doc-list');
  dl.innerHTML = docs.map(d=>`<option value="${d}"></option>`).join('');
  // Restore form body if links were shown
  document.getElementById('modal-create-body').innerHTML = getCreateFormHTML();
  bindCreateDoc();
  document.getElementById('modal-create').classList.add('show');
}

function getCreateFormHTML() {
  const docs = JSON.parse(localStorage.getItem('tm_doctors')||'[]');
  return `
  <div class="form-col">
    <div class="form-group"><label class="form-label">–§–ò–û –≤—Ä–∞—á–∞ *</label>
      <input type="text" id="c-doctor" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" list="doc-list" />
      <datalist id="doc-list">${docs.map(d=>`<option value="${d}"></option>`).join('')}</datalist>
    </div>
    <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –≤—Ä–∞—á–∞</label>
      <input type="tel" id="c-doctor-phone" placeholder="+7 700 000 00 00" />
    </div>
    <hr class="sep">
    <div class="form-group"><label class="form-label">–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞ *</label>
      <input type="text" id="c-patient" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á" />
    </div>
    <div class="form-group"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
      <input type="tel" id="c-patient-phone" placeholder="+7 700 000 00 00" />
    </div>
    <hr class="sep">
    <div class="form-row">
      <div class="form-group"><label class="form-label">–î–∞—Ç–∞ *</label><input type="date" id="c-date" value="${new Date().toISOString().slice(0,10)}" /></div>
      <div class="form-group"><label class="form-label">–í—Ä–µ–º—è *</label><input type="time" id="c-time" value="10:00" /></div>
    </div>
    <div id="create-alert" style="display:none"></div>
    <div class="modal-btns">
      <button class="btn btn-secondary" style="flex:1" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" style="flex:2" onclick="createConsultation()">–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏—ë–º</button>
    </div>
  </div>`;
}

function bindCreateDoc() {}

function closeCreateModal() {
  document.getElementById('modal-create').classList.remove('show');
}

let confirmCallback = null;
function showConfirm(title, text, cb) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-text').textContent  = text;
  confirmCallback = cb;
  document.getElementById('confirm-ok').onclick = () => { closeConfirm(); cb(); };
  document.getElementById('modal-confirm').classList.add('show');
}
function closeConfirm() {
  document.getElementById('modal-confirm').classList.remove('show');
}

// Close modals on overlay click
document.getElementById('modal-create').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeCreateModal();
});
document.getElementById('modal-confirm').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeConfirm();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let resetMode = false;

function toggleResetMode() {
  resetMode = !resetMode;
  const pw = document.getElementById('login-password');
  const btn = document.querySelector('#page-login .btn-primary');
  const link = document.querySelector('#page-login .btn-link');
  if (resetMode) {
    pw.style.display = 'none';
    document.getElementById('login-form-title').textContent = '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è';
    document.getElementById('login-form-sub').textContent = '–í–≤–µ–¥–∏—Ç–µ email ‚Äî –ø—Ä–∏—à–ª—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞';
    btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ';
    btn.onclick = doReset;
    link.textContent = '‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É';
  } else {
    pw.style.display = '';
    document.getElementById('login-form-title').textContent = '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É';
    document.getElementById('login-form-sub').textContent = '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
    btn.textContent = '–í–æ–π—Ç–∏';
    btn.onclick = doLogin;
    link.textContent = '–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?';
  }
}

function setLoginAlert(msg, ok=false) {
  const el = document.getElementById('login-alert');
  el.style.display = msg ? '' : 'none';
  el.className = 'alert ' + (ok ? 'alert-success' : 'alert-error');
  el.textContent = msg;
}

async function doLogin() {
  setLoginAlert('');
  const email    = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) { setLoginAlert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) setLoginAlert(error.message);
  else await enterAdmin();
}

async function doReset() {
  setLoginAlert('');
  const email = document.getElementById('login-email').value.trim();
  if (!email) { setLoginAlert('–í–≤–µ–¥–∏—Ç–µ email'); return; }
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin
  });
  if (error) setLoginAlert(error.message);
  else setLoginAlert('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.', true);
}

async function doLogout() {
  await sb.auth.signOut();
  showPage('login');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterAdmin() {
  const { data } = await sb.auth.getUser();
  if (data?.user) {
    document.getElementById('sidebar-email').textContent = data.user.email.split('@')[0];
  }
  showPage('admin');
  await loadConsultations();
  subscribeRealtime();
}

async function loadConsultations() {
  const { data, error } = await sb.from('consultations').select('*').order('scheduled_at', { ascending: false });
  if (!error) {
    consultations = data || [];
    renderStats();
    renderList();
  }
}

function subscribeRealtime() {
  if (realtimeChannel) sb.removeChannel(realtimeChannel);
  realtimeChannel = sb.channel('admin_rt')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'consultations' }, () => loadConsultations())
    .subscribe();
}

function renderStats() {
  document.getElementById('stat-active').textContent  = consultations.filter(c => !isExpired(c) && c.status==='scheduled').length;
  document.getElementById('stat-done').textContent    = consultations.filter(c => isExpired(c) || c.status==='completed').length;
  document.getElementById('stat-req').textContent     = consultations.filter(c => c.status==='cancel_requested').length;
  document.getElementById('stat-cancel').textContent  = consultations.filter(c => c.status==='cancelled').length;
}

function applyFilters(list) {
  const q   = document.getElementById('filter-search').value.toLowerCase();
  const dt  = document.getElementById('filter-date').value;
  const st  = document.getElementById('filter-status').value;
  const resetBtn = document.getElementById('filter-reset');
  resetBtn.style.display = (q || dt || st !== 'all') ? '' : 'none';
  return list.filter(c => {
    const ms = !q || c.doctor_name.toLowerCase().includes(q) || c.patient_name.toLowerCase().includes(q);
    const md = !dt || c.scheduled_at.slice(0,10) === dt;
    const mst = st === 'all' || c.status === st;
    return ms && md && mst;
  });
}

function resetFilters() {
  document.getElementById('filter-search').value = '';
  document.getElementById('filter-date').value = '';
  document.getElementById('filter-status').value = 'all';
  renderList();
}

function renderList() {
  const active    = applyFilters(consultations.filter(c => !isExpired(c)));
  const completed = applyFilters(consultations.filter(c => isExpired(c)));
  const el = document.getElementById('consult-list');

  if (active.length === 0 && completed.length === 0) {
    el.innerHTML = `<div class="empty-state">
      <div class="empty-icon">üìã</div>
      <div class="empty-text">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
      <div class="empty-sub">${document.getElementById('filter-search').value || document.getElementById('filter-date').value || document.getElementById('filter-status').value !== 'all'
        ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã'
        : '–ù–∞–∂–º–∏—Ç–µ ¬´+ –°–æ–∑–¥–∞—Ç—å¬ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'}</div>
    </div>`;
    return;
  }

  let html = active.map(c => rowHTML(c)).join('');

  if (completed.length > 0) {
    html += `<div class="section-toggle" onclick="toggleCompleted()">
      <span>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (${completed.length})</span>
      <span>${showCompleted ? '‚ñ≤' : '‚ñº'}</span>
    </div>`;
    if (showCompleted) html += completed.map(c => rowHTML(c)).join('');
  }
  el.innerHTML = html;
}

function toggleCompleted() {
  showCompleted = !showCompleted;
  renderList();
}

function rowHTML(c) {
  const sel = selectedId === c.id ? ' selected' : '';
  return `<div class="consult-row${sel}" onclick="selectConsult('${c.id}')">
    <div>
      <div class="row-patient">
        <span class="row-patient-name">${esc(c.patient_name)}</span>
        ${statusBadge(c.status)}
      </div>
      <div class="row-doctor">–í—Ä–∞—á: ${esc(c.doctor_name)}</div>
      <div class="row-date">${fmtDate(c.scheduled_at)}</div>
    </div>
    <span class="row-arrow">‚Ä∫</span>
  </div>`;
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function selectConsult(id) {
  selectedId = selectedId === id ? null : id;
  renderList();
  if (!selectedId) { closeDetail(); return; }
  const c = consultations.find(x => x.id === id);
  if (c) renderDetail(c);
}

function closeDetail() {
  selectedId = null;
  document.getElementById('detail-sidebar').classList.remove('show');
  renderList();
}

function renderDetail(c) {
  const sidebar = document.getElementById('detail-sidebar');
  const body    = document.getElementById('detail-body');
  const actions = document.getElementById('detail-actions');
  const expired = isExpired(c);
  const started = Date.now() > new Date(c.scheduled_at).getTime();

  let html = '';

  if (c.status === 'cancel_requested') {
    html += `<div class="alert alert-yellow">
      <strong>‚ö† –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É / –ø–µ—Ä–µ–Ω–æ—Å</strong><br>
      <span style="font-size:12px;line-height:1.7">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.<br>
      –ß—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ ‚Äî –∏–∑–º–µ–Ω–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.<br>
      –î–ª—è –æ—Ç–º–µ–Ω—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é¬ª.</span>
    </div>`;
  }

  html += `
    <div>
      <div class="detail-row"><span class="detail-label">–°—Ç–∞—Ç—É—Å</span><span class="detail-value">${statusBadge(c.status)}</span></div>
      <div class="detail-row"><span class="detail-label">–í—Ä–∞—á</span><span class="detail-value">${esc(c.doctor_name)}</span></div>
      <div class="detail-row"><span class="detail-label">–ü–∞—Ü–∏–µ–Ω—Ç</span><span class="detail-value">${esc(c.patient_name)}</span></div>
      ${c.doctor_phone  ? `<div class="detail-row"><span class="detail-label">–¢–µ–ª. –≤—Ä–∞—á–∞</span><span class="detail-value">${esc(c.doctor_phone)}</span></div>`  : ''}
      ${c.patient_phone ? `<div class="detail-row"><span class="detail-label">–¢–µ–ª. –ø–∞—Ü–∏–µ–Ω—Ç–∞</span><span class="detail-value">${esc(c.patient_phone)}</span></div>` : ''}
    </div>
    <hr class="detail-sep">`;

  if (!expired && c.status !== 'cancelled') {
    const d = c.scheduled_at.slice(0,10);
    const t = c.scheduled_at.slice(11,16);
    html += `<div>
      <span class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞</span>
      <div class="form-row">
        <input type="date" id="d-edit-date" value="${d}" />
        <input type="time" id="d-edit-time" value="${t}" />
      </div>
    </div>`;
  } else {
    html += `<div class="detail-row"><span class="detail-label">–î–∞—Ç–∞</span><span class="detail-value">${fmtDate(c.scheduled_at)}</span></div>`;
  }

  // Links
  [['–°—Å—ã–ª–∫–∞ ‚Äî –≤—Ä–∞—á', c.doctor_link], ['–°—Å—ã–ª–∫–∞ ‚Äî –ø–∞—Ü–∏–µ–Ω—Ç', c.patient_link]].forEach(([label, url]) => {
    html += `<div>
      <span class="form-label">${label}</span>
      <div class="link-box">
        <span class="link-url">${esc(url||'‚Äî')}</span>
        ${url ? `<button class="btn-copy" onclick="copyText('${esc(url)}')">‚éò</button>` : ''}
      </div>
    </div>`;
  });

  body.innerHTML = html;

  // Actions
  let actHTML = '';
  if (!expired && c.status !== 'cancelled') {
    actHTML += `<button class="btn btn-primary btn-full" onclick="saveConsult('${c.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
    if (!started) actHTML += `<button class="btn btn-danger btn-full" onclick="confirmDelete('${c.id}')">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
    actHTML += `<button class="btn btn-secondary btn-full" onclick="confirmCancel('${c.id}')">–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</button>`;
  }
  actions.innerHTML = actHTML;
  sidebar.classList.add('show');
}

async function createConsultation() {
  const doctor  = document.getElementById('c-doctor')?.value?.trim();
  const patient = document.getElementById('c-patient')?.value?.trim();
  const date    = document.getElementById('c-date')?.value;
  const time    = document.getElementById('c-time')?.value;
  if (!doctor || !patient || !date || !time) {
    setCreateAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', false); return;
  }
  setCreateAlert('');
  const scheduled_at = new Date(`${date}T${time}:00`).toISOString();
  const { data, error } = await sb.from('consultations').insert({
    doctor_name:  doctor,
    patient_name: patient,
    doctor_phone:  document.getElementById('c-doctor-phone')?.value  || null,
    patient_phone: document.getElementById('c-patient-phone')?.value || null,
    scheduled_at, status: 'scheduled',
    doctor_link: '', patient_link: '',
  }).select().single();
  if (error) { setCreateAlert(error.message, false); return; }

  const base  = window.location.origin + window.location.pathname;
  const dLink = `${base}?role=doctor&id=${data.id}`;
  const pLink = `${base}?role=patient&id=${data.id}`;
  await sb.from('consultations').update({ doctor_link: dLink, patient_link: pLink }).eq('id', data.id);

  const docs = JSON.parse(localStorage.getItem('tm_doctors')||'[]');
  localStorage.setItem('tm_doctors', JSON.stringify([doctor, ...docs.filter(d=>d!==doctor)].slice(0,30)));

  // Show links
  document.getElementById('modal-create-body').innerHTML = `
    <div class="form-col">
      <div class="alert alert-success">‚úì –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞! –°—Å—ã–ª–∫–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 3 —á–∞—Å–∞ —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞.</div>
      <div>
        <span class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ä–∞—á–∞</span>
        <div class="link-box"><span class="link-url">${esc(dLink)}</span>
          <button class="btn-copy" onclick="copyText('${esc(dLink)}')">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
      </div>
      <div>
        <span class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞</span>
        <div class="link-box"><span class="link-url">${esc(pLink)}</span>
          <button class="btn-copy" onclick="copyText('${esc(pLink)}')">‚éò –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
      </div>
      <button class="btn btn-primary btn-full" onclick="closeCreateModal()">–ì–æ—Ç–æ–≤–æ</button>
    </div>`;
  loadConsultations();
}

function setCreateAlert(msg, ok=false) {
  const el = document.getElementById('create-alert');
  if (!el) return;
  el.style.display = msg ? '' : 'none';
  el.className = 'alert ' + (ok ? 'alert-success' : 'alert-error');
  el.textContent = msg;
}

function copyText(txt) {
  navigator.clipboard.writeText(txt).then(() => showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'success'));
}

async function saveConsult(id) {
  const dateEl = document.getElementById('d-edit-date');
  const timeEl = document.getElementById('d-edit-time');
  if (!dateEl || !timeEl) return;
  const scheduled_at = new Date(`${dateEl.value}T${timeEl.value}`).toISOString();
  const { error } = await sb.from('consultations').update({ scheduled_at, status: 'scheduled' }).eq('id', id);
  if (error) showToast(error.message, 'error');
  else { showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); loadConsultations(); closeDetail(); }
}

function confirmCancel(id) {
  showConfirm('–û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?',
    '–í—Ä–∞—á –∏ –ø–∞—Ü–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞—Ç SMS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω—ã).',
    () => doCancel(id));
}

async function doCancel(id) {
  await sb.from('consultations').update({ status: 'cancelled' }).eq('id', id);
  showToast('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'info');
  loadConsultations(); closeDetail();
}

function confirmDelete(id) {
  showConfirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?', '–ó–∞–ø–∏—Å—å –±—É–¥–µ—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω–∞.', () => doDelete(id));
}

async function doDelete(id) {
  await sb.from('consultations').delete().eq('id', id);
  showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'info');
  loadConsultations(); closeDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALL PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enterCall(role, consultId) {
  callRole = role;
  callConsultId = consultId;
  chatMessages = [];
  unreadCount = 0;
  chatOpen = false;
  micOn = true; camOn = true;

  const { data: c } = await sb.from('consultations').select('*').eq('id', consultId).single();
  if (!c) { showInfo('‚ùì','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—É.'); return; }
  if (c.status === 'cancelled') { showInfo('‚ùå','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞','–î–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–ª–∏–Ω–∏–∫–æ–π.'); return; }
  if (isExpired(c)) { showInfo('‚è∞','–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫–ª–æ','–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —á–∞—Å–æ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.'); return; }

  // Waiting room
  if (!isActiveNow(c)) {
    document.getElementById('waiting-role-label').textContent = role === 'patient' ? '–í–∞—à–∞ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è' : '–û–Ω–ª–∞–π–Ω-–ø—Ä–∏—ë–º –ø–∞—Ü–∏–µ–Ω—Ç–∞';
    document.getElementById('waiting-name').textContent = role === 'patient' ? `–í—Ä–∞—á: ${c.doctor_name}` : `–ü–∞—Ü–∏–µ–Ω—Ç: ${c.patient_name}`;
    document.getElementById('waiting-date').textContent = fmtDate(c.scheduled_at);
    if (role === 'patient') document.getElementById('payment-block').style.display = '';
    showPage('waiting');
    startCountdown(c.scheduled_at, () => enterCall(role, consultId));
    return;
  }

  // Active call
  stopCountdown();
  document.getElementById('call-peer-label').textContent = role === 'patient' ? `–í—Ä–∞—á: ${c.doctor_name}` : `–ü–∞—Ü–∏–µ–Ω—Ç: ${c.patient_name}`;
  document.getElementById('waiting-peer-text').textContent = `–û–∂–∏–¥–∞–µ–º ${role === 'doctor' ? '–ø–∞—Ü–∏–µ–Ω—Ç–∞' : '–≤—Ä–∞—á–∞'}...`;
  document.getElementById('waiting-overlay').style.display = 'flex';
  document.getElementById('chat-messages').innerHTML = '<div class="chat-empty">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É...</div>';
  document.getElementById('chat-panel').classList.remove('show');
  document.getElementById('chat-badge').style.display = 'none';
  document.getElementById('btn-mic').className = 'ctrl-btn';
  document.getElementById('btn-cam').className = 'ctrl-btn';
  document.getElementById('btn-chat').className = 'ctrl-btn';
  showPage('call');

  await startMedia();
  startSignaling(role, consultId, c);

  // Watch for cancellation
  sb.channel(`watch_${consultId}`)
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'consultations',filter:`id=eq.${consultId}`},
      ({new:u}) => { if (u.status==='cancelled') showInfo('‚ùå','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞','–î–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.'); })
    .subscribe();
}

function startCountdown(targetDate, onDone) {
  stopCountdown();
  function tick() {
    const diff = Math.max(0, new Date(targetDate).getTime() - Date.now());
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    document.getElementById('cd-h').textContent = pad(h);
    document.getElementById('cd-m').textContent = pad(m);
    document.getElementById('cd-s').textContent = pad(s);
    if (diff <= 0 && onDone) { stopCountdown(); onDone(); }
  }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

function stopCountdown() {
  if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
}

async function startMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('local-video').srcObject = localStream;
  } catch (e) {
    showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
  }
}

function startSignaling(role, consultId, c) {
  const peerRole = role === 'patient' ? 'doctor' : 'patient';

  if (sigChannel) sb.removeChannel(sigChannel);
  sigChannel = sb.channel(`sig_${consultId}`, { config: { presence: { key: role } } });

  sigChannel.on('broadcast',{event:'signal'}, async ({payload}) => {
    if (payload.to !== role) return;
    const pc = peerConn;
    if (!pc) return;
    try {
      if (payload.offer)  { await pc.setRemoteDescription(payload.offer); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); sigChannel.send({type:'broadcast',event:'signal',payload:{to:peerRole,answer:ans}}); }
      if (payload.answer) await pc.setRemoteDescription(payload.answer);
      if (payload.ice)    await pc.addIceCandidate(payload.ice);
    } catch(e) {}
  });

  sigChannel.on('broadcast',{event:'chat'},({payload}) => {
    chatMessages.push(payload);
    appendChatMsg(payload);
    if (!chatOpen) { unreadCount++; updateBadge(); }
  });

  sigChannel.on('broadcast',{event:'end'},() => {
    showEndedPage();
  });

  sigChannel.on('presence',{event:'sync'},() => {
    const state = sigChannel.presenceState();
    const peerHere = !!state[peerRole];
    document.getElementById('waiting-overlay').style.display = peerHere ? 'none' : 'flex';
    if (peerHere && !peerConn) setupPeerConnection(role, peerRole);
  });

  sigChannel.subscribe(async (s) => {
    if (s !== 'SUBSCRIBED') return;
    await sigChannel.track({ online: true });
  });
}

function setupPeerConnection(role, peerRole) {
  const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  peerConn = pc;

  if (localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = e => { document.getElementById('remote-video').srcObject = e.streams[0]; };
  pc.onicecandidate = e => {
    if (e.candidate && sigChannel) sigChannel.send({type:'broadcast',event:'signal',payload:{to:peerRole,ice:e.candidate}});
  };

  if (role === 'doctor') {
    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      sigChannel.send({type:'broadcast',event:'signal',payload:{to:'patient',offer}});
    });
  }
}

function toggleMic() {
  micOn = !micOn;
  localStream?.getAudioTracks().forEach(t => t.enabled = micOn);
  const btn = document.getElementById('btn-mic');
  btn.textContent = micOn ? 'üéô' : 'üîá';
  btn.className = 'ctrl-btn' + (micOn ? '' : ' off');
}

function toggleCam() {
  camOn = !camOn;
  localStream?.getVideoTracks().forEach(t => t.enabled = camOn);
  const btn = document.getElementById('btn-cam');
  btn.textContent = camOn ? 'üìπ' : 'üì∑';
  btn.className = 'ctrl-btn' + (camOn ? '' : ' off');
  document.getElementById('cam-off-overlay').style.display = camOn ? 'none' : 'flex';
}

function toggleChat() {
  chatOpen = !chatOpen;
  unreadCount = 0;
  updateBadge();
  const panel = document.getElementById('chat-panel');
  if (chatOpen) { panel.classList.add('show'); document.getElementById('local-video-wrap').style.right = '376px'; }
  else          { panel.classList.remove('show'); document.getElementById('local-video-wrap').style.right = '16px'; }
  document.getElementById('btn-chat').className = 'ctrl-btn' + (chatOpen ? ' active' : '');
  scrollChat();
}

function updateBadge() {
  const b = document.getElementById('chat-badge');
  if (unreadCount > 0 && !chatOpen) { b.style.display='flex'; b.textContent=unreadCount; }
  else b.style.display = 'none';
}

function sendMsg() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || !sigChannel) return;
  const m = { from: callRole, text, ts: Date.now() };
  sigChannel.send({ type:'broadcast', event:'chat', payload: m });
  chatMessages.push(m);
  appendChatMsg(m);
  input.value = '';
}

function appendChatMsg(m) {
  const container = document.getElementById('chat-messages');
  const empty = container.querySelector('.chat-empty');
  if (empty) empty.remove();
  const mine = m.from === callRole;
  const div = document.createElement('div');
  div.className = 'msg-wrap' + (mine ? ' mine' : '');
  div.innerHTML = `<div class="msg-bubble ${mine?'mine':'theirs'}">
    ${!mine ? `<div class="msg-from">${m.from==='doctor'?'–í—Ä–∞—á':'–ü–∞—Ü–∏–µ–Ω—Ç'}</div>` : ''}
    ${esc(m.text)}
    <div class="msg-time ${mine?'mine':'theirs'}">${new Date(m.ts).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}</div>
  </div>`;
  container.appendChild(div);
  scrollChat();
}

function scrollChat() {
  const c = document.getElementById('chat-messages');
  c.scrollTop = c.scrollHeight;
}

async function endCall() {
  sigChannel?.send({type:'broadcast',event:'end',payload:{}});
  if (callRole === 'doctor') {
    await sb.from('consultations').update({status:'completed'}).eq('id',callConsultId);
  }
  cleanupCall();
  showEndedPage();
}

function cleanupCall() {
  localStream?.getTracks().forEach(t => t.stop());
  peerConn?.close();
  localStream = null; peerConn = null;
  if (sigChannel) { sb.removeChannel(sigChannel); sigChannel = null; }
}

function showEndedPage() {
  cleanupCall();
  document.getElementById('ended-text').textContent = callRole === 'patient'
    ? '–°–ø–∞—Å–∏–±–æ! –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–∞ email.'
    : '–ü—Ä–∏—ë–º –∑–∞–≤–µ—Ä—à—ë–Ω. –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.';
  const emailSection = document.getElementById('ended-email-section');
  emailSection.style.display = (callRole === 'patient' && chatMessages.length > 0) ? '' : 'none';
  document.getElementById('ended-sent').style.display = 'none';
  showPage('ended');
}

function sendChatHistory() {
  const email = document.getElementById('ended-email').value;
  if (!email) return;
  document.getElementById('ended-sent').style.display = '';
  document.getElementById('ended-sent').textContent = `‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ${email} (—Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —á–µ—Ä–µ–∑ Supabase Edge Functions)`;
  document.getElementById('ended-email-section').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  showPage('loading');

  const params = new URLSearchParams(window.location.search);
  const role   = params.get('role');
  const id     = params.get('id');

  const { data: { session } } = await sb.auth.getSession();

  if (role && id) {
    // Call pages ‚Äî no auth needed
    await enterCall(role, id);
    return;
  }

  if (session) {
    await enterAdmin();
  } else {
    showPage('login');
  }

  // Auth listener
  sb.auth.onAuthStateChange(async (_e, s) => {
    if (s && !role) await enterAdmin();
    else if (!s && !role) showPage('login');
  });
}

init();
</script>
</body>
</html>
